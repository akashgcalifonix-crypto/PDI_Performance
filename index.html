<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System v9.0 (Date Fix & Bar Graphs)</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #0f172a; --secondary: #334155; --accent: #2563eb; --success: #10b981; --danger: #ef4444; }
        
        /* BIG FONT STYLES */
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; font-size: 18px; }
        
        .app-header { background: var(--primary); padding: 15px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-pills .nav-link { font-size: 18px; font-weight: 600; padding: 12px 25px; color: #cbd5e1; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; }

        /* INPUTS & BUTTONS */
        .form-control, .form-select { font-size: 18px; padding: 10px 15px; }
        .btn { font-size: 18px; padding: 10px 24px; font-weight: 600; }
        
        /* TABLE STYLES */
        .table th { font-size: 16px; text-transform: uppercase; background: #f8fafc; padding: 15px; }
        .table td { font-size: 18px; padding: 15px; vertical-align: middle; }
        
        /* PREVIEW MODAL SPECIFIC */
        .pro-table th { background: #e2e8f0; font-weight: 700; font-size: 17px; }
        .pro-table td { font-size: 19px; }
        .pro-table .total-row { background: var(--primary) !important; color: white; font-weight: bold; font-size: 20px; }
        
        /* DASHBOARD KPI BOXES */
        .kpi-box { background: white; padding: 20px; border-radius: 12px; border-left: 6px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-val { font-size: 40px; font-weight: 800; color: var(--primary); }
        
        .card { border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: none; margin-bottom: 25px; }
        .edit-active { background-color: #fffbeb !important; border: 2px dashed #f59e0b !important; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Status Badges */
        .st-pass { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .st-fail { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
    <div class="mt-3 fw-bold fs-4">Syncing...</div>
</div>

<div class="app-header no-print d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 45px;" class="bg-white rounded p-1">
        <h4 class="m-0 fw-bold text-white">PDI MASTER <span style="color: var(--accent);">PRO</span></h4>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)">Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard', this)">Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure', this)">Closure</button>
    </div>
</div>

<div class="container-fluid mt-4 px-4">
    
    <!-- ENTRY TAB -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex" value="">
            <div class="card p-4" id="formCard">
                <div class="row g-4 align-items-end">
                    <div class="col-md-3">
                        <label class="fw-bold text-secondary">SELECT DATE</label>
                        <input type="date" id="entryDate" class="form-control fw-bold" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-outline-primary" id="addRowBtn" onclick="addLotRow()">
                            <i class="bi bi-plus-lg me-2"></i>Add Line Item
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-3 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0 text-center" style="min-width: 1400px;">
                        <thead class="text-secondary">
                            <tr><th>LINE</th><th>MODEL</th><th>COLOUR</th><th>LOT ID</th><th>QTY</th><th>STATUS</th><th>RESULT</th><th>REMARKS</th><th></th></tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4 mb-5">
                <button type="button" class="btn btn-light border px-4" onclick="resetForm()">Cancel</button>
                <button type="submit" id="saveBtn" class="btn btn-primary px-5 shadow-sm">SAVE RECORDS</button>
            </div>
        </form>

        <div class="card">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <span class="fw-bold fs-5 text-secondary">Recent Entries</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control w-auto" onchange="renderRecentTable()">
                    <button class="btn btn-dark px-3" onclick="showDaySummary()">Preview Report</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle mb-0">
                    <thead class="table-dark"><tr><th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Actions</th></tr></thead>
                    <tbody id="crudTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DASHBOARD TAB (RESTORED & BAR GRAPHS) -->
    <div id="tab-dashboard" style="display:none;">
        <div class="card p-4 mb-4 no-print">
            <div class="row g-4 align-items-end">
                <div class="col-md-3"><label class="fw-bold">From</label><input type="date" id="dashFrom" class="form-control"></div>
                <div class="col-md-3"><label class="fw-bold">To</label><input type="date" id="dashTo" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="runDashboardAnalysis()">Apply Filter</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger" onclick="downloadPDF()">Download PDF</button></div>
            </div>
        </div>
        <div id="pdf-content">
            <div class="row g-4 mb-5 text-center">
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="d_lots">0</div><div>Total Lots</div></div></div>
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="d_qty">0</div><div>Total Qty</div></div></div>
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val text-success" id="d_lar">0%</div><div>Overall LAR %</div></div></div>
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val text-primary" id="d_pass">0%</div><div>Pass Rate %</div></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header fw-bold">Daily Trend (Bar)</div><div class="card-body"><div id="ch_trend" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header fw-bold">Line Performance (Bar)</div><div class="card-body"><div id="ch_line" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header fw-bold">Floor Pass % (Bar)</div><div class="card-body"><div id="ch_floor" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header fw-bold">Defect Analysis (Bar)</div><div class="card-body"><div id="ch_defects" style="height:350px"></div></div></div></div>
            </div>
        </div>
    </div>

    <!-- CLOSURE TAB (RESTORED) -->
    <div id="tab-closure" style="display:none;">
        <div class="alert alert-warning p-4 fs-5"><strong>Pending Lots for Rework/Re-test</strong></div>
        <div class="row g-4">
            <div class="col-md-4"><div class="card h-100"><div class="card-header bg-dark text-white text-center fs-5">Floor 1 Pending</div><div class="card-body fs-5" id="list_f1"></div></div></div>
            <div class="col-md-4"><div class="card h-100"><div class="card-header bg-dark text-white text-center fs-5">Floor 2 Pending</div><div class="card-body fs-5" id="list_f2"></div></div></div>
            <div class="col-md-4"><div class="card h-100"><div class="card-header bg-dark text-white text-center fs-5">Basement Pending</div><div class="card-body fs-5" id="list_fb"></div></div></div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h4 class="modal-title fw-bold">Production Summary</h4>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4" id="summaryBody"></div>
            <div class="modal-footer bg-white">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyvBKmQ9GDPwPJXiSBh7En0YPTrJ3uemT7T6nlx-j9EGLJI6fPHXGRhExla4ImSfFyf/exec";
const MODELS = ["Unity ANC","Ace","111v2","131 Elite Anc","131 Gen 2","141 Anc","161 Anc","161 N","181 Pro","191 Anc","192","212","280 Anc","300","71","800","91","Ace Gen 2","Hype","Kick","Nirvana Crystal","Nirvana Iris","Nirvana X","Plus 311","Prime 412","Primo","Pulse","Supreme","Ultra Pro","100","121 Pro","131","141","161","161 Pro-Buds","181","190","191 G","207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","HMD P50","HMD S60","HMD X50","IMT 100","IMT121","IMT131","IMT161","Joy","Max","Nirvana","Nirvana Ion","R 195 Pro","Ultra Plus","Zing"];
const COLOURS = ["Black","Blue","Bold Blue","Crimson Cream","Graphite Grey","Ivory White","Krypton Blue","Lavender Rush","Moon White","Pine Green","Space Grey","Sterling Silver","White","Zinc White","Active Black","Active Teal","Aqua Blue","Ash Grey","Assassin Black","Azure Blue","Berry Blue","Carbon Black","Charcoal Black","Cherry Blossom","Cool Grey","Cosmic Onyx","Cream White","Crimsom Red","Crystal Black","Cyan cider","Deep Blue","Electric Blue","Emerald Green","Frost White","Galactic Purple","Gunmetal Black","Ice Blue","Ivory","Jet Black","Lunar White","Maroon Lush","Martian Green","Metallic Grey","Midnight Black","Midnight Blue","Mint Blue","Mist Grey","Mystic Blue","Noir Black","Ocean Blue","Olive Green","Opal Black","Orange","Peach Blush","Pearl White","Pellucid Blue","Purple","Quantum Black","Red","Rose Quartz","Saga Green","Sandstone","Shadow Black","Silver","Slate Grey","Sleek Black","Sonic Silver","Spirit White","Sporty Blue","Starry Blue","Sunset Blush","Teal","Thunder Blue","Velvet Rouge","Yellow Pop"];

let sheetData = [];
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = function() {
    let today = new Date().toLocaleDateString('en-CA'); // Force YYYY-MM-DD local
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    document.getElementById('dashFrom').value = today;
    document.getElementById('dashTo').value = today;
    addLotRow();
    loadAllData();
};

function switchTab(tab, btn) {
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
    if(tab === 'dashboard') runDashboardAnalysis();
    if(tab === 'closure') runClosureReport();
}

// *** CRITICAL DATE FIX ***
// Ab hum time part ko ignore karke sirf date string match karenge
function getCleanDate(isoString) {
    if(!isoString) return "";
    // Sheet se "2025-12-19T22:00:00.000Z" aa sakta hai
    // Hum naya Date object banake local date nikalenge
    let d = new Date(isoString);
    // India is UTC+5:30. 
    // Best way: use toLocaleDateString with 'en-CA' (YYYY-MM-DD)
    return d.toLocaleDateString('en-CA');
}

async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0] && sheetData[0][0] === "Date") sheetData.shift(); 
        renderRecentTable();
    } catch(e) { console.error(e); }
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const fDate = document.getElementById('recentFilter').value; // User selected date (YYYY-MM-DD)
    tb.innerHTML = "";
    
    // Reverse loop to show latest first
    sheetData.slice().reverse().forEach(r => {
        let rowDate = getCleanDate(r[0]); // Convert Sheet date to YYYY-MM-DD
        
        if (rowDate === fDate) {
            let originalIndex = sheetData.indexOf(r);
            let displayDate = rowDate.split('-').reverse().join('/'); // Show as DD/MM/YYYY
            let statusClass = r[8] === 'Pass' ? 'st-pass' : 'st-fail';

            tb.innerHTML += `<tr>
                <td>${displayDate}</td><td>L${r[1]}</td><td>${r[3]}</td><td class="fw-bold text-dark">${r[5]}</td><td>${r[6]}</td>
                <td><span class="${statusClass}">${r[8]}</span></td>
                <td>
                    <button class="btn btn-light border btn-sm text-warning" onclick="editRec(${originalIndex})"><i class="bi bi-pencil-fill"></i></button>
                    <button class="btn btn-light border btn-sm text-danger" onclick="deleteRec(${originalIndex})"><i class="bi bi-trash-fill"></i></button>
                </td>
            </tr>`;
        }
    });
}

function showDaySummary() {
    const fDate = document.getElementById('recentFilter').value;
    
    // Filter data using clean date fix
    let dayData = sheetData.filter(r => getCleanDate(r[0]) === fDate);
    
    if(!dayData.length) return alert("No data found for selected date: " + fDate);

    let pLots=0, fLots=0, tQty=0, pQty=0;
    let floors = {"Floor 1":{tQ:0, pQ:0, tL:0, pL:0}, "Floor 2":{tQ:0, pQ:0, tL:0, pL:0}, "Basement":{tQ:0, pQ:0, tL:0, pL:0}};
    let rejects = [];

    dayData.forEach(r => {
        let q = parseInt(r[6]||0), fl = r[2] || "Floor 1";
        if(!floors[fl]) floors[fl] = {tQ:0, pQ:0, tL:0, pL:0};

        tQty += q; floors[fl].tQ += q; floors[fl].tL++;
        if(r[8]==='Pass') { 
            pLots++; pQty += q; 
            floors[fl].pL++; floors[fl].pQ += q; 
        } else { 
            fLots++; rejects.push(r); 
        }
    });

    let passRate = tQty > 0 ? ((pQty / tQty) * 100).toFixed(2) : "0.00";
    
    // Totals Calculation
    let g_Lots = 0, g_PassL = 0, g_Qty = 0, g_PassQ = 0;
    Object.keys(floors).forEach(f => {
        g_Lots += floors[f].tL; g_PassL += floors[f].pL;
        g_Qty += floors[f].tQ; g_PassQ += floors[f].pQ;
    });
    let g_Rate = g_Qty > 0 ? ((g_PassQ/g_Qty)*100).toFixed(2) : "0.00";

    let html = `
        <h5 class="text-center mb-4">Date: ${fDate.split('-').reverse().join('/')}</h5>
        <div class="row g-4 mb-4">
            <div class="col-md-3"><div class="card p-3 text-center bg-dark text-white"><h3>${pLots+fLots}</h3><small>Total Lots</small></div></div>
            <div class="col-md-3"><div class="card p-3 text-center bg-success text-white"><h3>${pLots}</h3><small>Passed</small></div></div>
            <div class="col-md-3"><div class="card p-3 text-center bg-danger text-white"><h3>${fLots}</h3><small>Rejected</small></div></div>
            <div class="col-md-3"><div class="card p-3 text-center bg-primary text-white"><h3>${passRate}%</h3><small>Pass Rate</small></div></div>
        </div>

        <h5 class="fw-bold">Floor Performance</h5>
        <div class="card border-0 shadow-sm mb-4">
            <table class="table pro-table mb-0 text-center table-bordered">
                <thead><tr><th class="bg-light">Floor Name</th><th>Lots</th><th>Passed</th><th>Total Qty</th><th>Pass Qty</th><th>Rate %</th></tr></thead>
                <tbody>
                    ${Object.keys(floors).map(f => {
                        let rate = floors[f].tQ ? ((floors[f].pQ/floors[f].tQ)*100).toFixed(2) : "0.00";
                        return `<tr><td class="fw-bold text-start ps-4">${f}</td><td>${floors[f].tL}</td><td>${floors[f].pL}</td><td>${floors[f].tQ}</td><td>${floors[f].pQ}</td><td>${rate}%</td></tr>`;
                    }).join('')}
                </tbody>
                <tfoot class="total-row">
                    <tr><td class="text-start ps-4">GRAND TOTAL</td><td>${g_Lots}</td><td>${g_PassL}</td><td>${g_Qty}</td><td>${g_PassQ}</td><td>${g_Rate}%</td></tr>
                </tfoot>
            </table>
        </div>

        <h5 class="fw-bold text-danger">Rejections</h5>
        ${rejects.length > 0 ? `
            <table class="table table-bordered text-center"><thead class="table-danger"><tr><th>Line</th><th>Model</th><th>ID</th><th>Reason</th></tr></thead>
            <tbody>${rejects.map(r => `<tr><td>L${r[1]}</td><td>${r[3]}</td><td>${r[5]}</td><td class="text-danger">${r[9]}</td></tr>`).join('')}</tbody></table>
        ` : `<div class="alert alert-success">No Rejections</div>`}
    `;
    
    document.getElementById('summaryBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function addLotRow(data = null) {
    const tr = document.createElement('tr'); tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">L${i}</option>`;
    
    tr.innerHTML = `
        <td><select class="form-select i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control i-id fw-bold text-uppercase" placeholder="ID" required></td>
        <td><input type="number" class="form-control i-qty" placeholder="0" required></td>
        <td><select class="form-select i-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select i-res fw-bold" onchange="toggleRem(this)"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control i-rem" placeholder="Remarks" disabled></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm border-0 px-3" onclick="this.closest('tr').remove()"><i class="bi bi-x-lg"></i></button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);
    
    if(data) {
        tr.querySelector('.i-line').value = data[1];
        tr.querySelector('.i-model').value = data[3];
        tr.querySelector('.i-color').value = data[4];
        tr.querySelector('.i-id').value = data[5];
        tr.querySelector('.i-qty').value = data[6];
        tr.querySelector('.i-status').value = data[7];
        tr.querySelector('.i-res').value = data[8];
        if(data[8]==='Fail'){ 
            tr.querySelector('.i-rem').disabled=false; 
            tr.querySelector('.i-rem').value=data[9]; 
        }
    }
}

function toggleRem(sel) {
    const row = sel.closest('tr');
    const rem = row.querySelector('.i-rem');
    rem.disabled = (sel.value === 'Pass');
    if(sel.value === 'Pass') rem.value = ""; else rem.focus();
}

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    const editIdx = document.getElementById('editRowIndex').value;
    document.getElementById('loader').style.display='flex';
    
    let rows = [];
    document.querySelectorAll('.input-row').forEach(tr => {
        let l = parseInt(tr.querySelector('.i-line').value);
        let floor = (l <= 8) ? "Floor 1" : (l <= 16 ? "Floor 2" : "Basement");
        rows.push([
            document.getElementById('entryDate').value, l, floor, 
            tr.querySelector('.i-model').value, tr.querySelector('.i-color').value, 
            tr.querySelector('.i-id').value.toUpperCase(), tr.querySelector('.i-qty').value, 
            tr.querySelector('.i-status').value, tr.querySelector('.i-res').value, 
            tr.querySelector('.i-rem').value||""
        ]);
    });

    let payload = (editIdx && editIdx !== "") ? { action: 'edit', rowIndex: parseInt(editIdx), data: rows[0] } : { action: 'save', data: rows };

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        resetForm(); await loadAllData();
        alert("Saved!");
    } catch (err) { alert("Error"); }
    document.getElementById('loader').style.display='none';
};

async function deleteRec(idx) {
    if(!confirm("Delete?")) return;
    document.getElementById('loader').style.display='flex';
    await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex: idx + 2})});
    await loadAllData();
}

function editRec(idx) {
    const r = sheetData[idx];
    document.getElementById('editRowIndex').value = (idx + 2);
    document.getElementById('entryDate').value = getCleanDate(r[0]); // Fix edit date too
    document.getElementById('lotContainer').innerHTML=""; addLotRow(r);
    
    const sBtn = document.getElementById('saveBtn');
    sBtn.innerText = 'UPDATE RECORD';
    sBtn.className = "btn btn-warning px-5 shadow-sm text-dark fw-bold";
    document.getElementById('formCard').className="card p-4 edit-active";
    document.getElementById('addRowBtn').style.display = 'none';
    window.scrollTo(0,0);
}

function resetForm() {
    document.getElementById('pdiForm').reset();
    document.getElementById('editRowIndex').value = "";
    document.getElementById('lotContainer').innerHTML = ""; addLotRow();
    document.getElementById('saveBtn').innerText = 'SAVE RECORDS';
    document.getElementById('saveBtn').className = "btn btn-primary px-5 shadow-sm";
    document.getElementById('formCard').className = "card p-4";
    document.getElementById('addRowBtn').style.display = 'inline-block';
}

function runDashboardAnalysis() {
    const from = document.getElementById('dashFrom').value, to = document.getElementById('dashTo').value;
    let dLots=0, dQty=0, pLots=0, pQty=0;
    // Data structures for graphs
    let dates={}, lines={}, floors={}, defects={}; 

    sheetData.forEach(r => {
        let rd = getCleanDate(r[0]); // Date Fix
        if(rd >= from && rd <= to) {
            let q = parseInt(r[6]||0), ln="L"+r[1], fl=r[2], res=r[8], def=r[9];
            
            dLots++; dQty += q;
            
            // Init counters
            if(!dates[rd]) dates[rd] = {p:0, t:0};
            if(!lines[ln]) lines[ln] = {p:0, t:0};
            if(!floors[fl]) floors[fl] = {p:0, t:0};

            dates[rd].t += q; lines[ln].t += q; floors[fl].t += q;

            if(res === 'Pass') { 
                pLots++; pQty += q; 
                dates[rd].p += q; lines[ln].p += q; floors[fl].p += q; 
            } else {
                if(def) defects[def] = (defects[def] || 0) + 1;
            }
        }
    });

    // Update KPI
    document.getElementById('d_lots').innerText = dLots; 
    document.getElementById('d_qty').innerText = dQty;
    document.getElementById('d_lar').innerText = dLots ? (pLots/dLots*100).toFixed(1)+"%" : "0%";
    document.getElementById('d_pass').innerText = dQty ? (pQty/dQty*100).toFixed(1)+"%" : "0%";

    // Helper for Bar Charts
    const drawBar = (id, arr, title) => {
        let dt = google.visualization.arrayToDataTable([['Item', 'Value', { role: 'style' }], ...arr]);
        new google.visualization.ColumnChart(document.getElementById(id)).draw(dt, {
            title: title, legend: { position: "none" }, colors:['#2563eb']
        });
    };

    // 1. Trend Bar
    let dArr = Object.keys(dates).sort().map(d => [d.split('-').reverse().slice(0,2).join('/'), (dates[d].t?(dates[d].p/dates[d].t)*100:0), '#0f172a']);
    drawBar('ch_trend', dArr, 'Daily Pass Rate %');

    // 2. Line Bar
    let lArr = Object.keys(lines).map(l => [l, (lines[l].t?(lines[l].p/lines[l].t)*100:0), '#2563eb']);
    drawBar('ch_line', lArr, 'Line Wise Pass %');

    // 3. Floor Bar
    let fArr = Object.keys(floors).map(f => [f, (floors[f].t?(floors[f].p/floors[f].t)*100:0), '#10b981']);
    drawBar('ch_floor', fArr, 'Floor Wise Pass %');

    // 4. Defect Bar (Counts)
    let dfArr = Object.keys(defects).map(d => [d, defects[d], '#ef4444']);
    drawBar('ch_defects', dfArr, 'Defect Frequency');
}

function runClosureReport() {
    let f1=document.getElementById('list_f1'), f2=document.getElementById('list_f2'), fb=document.getElementById('list_fb');
    f1.innerHTML=f2.innerHTML=fb.innerHTML="";
    
    sheetData.forEach(r => {
        if(r[8] !== 'Pass') {
            let item = `<div class="p-2 border-bottom border-secondary mb-2">
                <div class="fw-bold text-danger">${r[5]}</div>
                <small>${r[3]} | ${r[9]||"No Remark"}</small>
            </div>`;
            if(r[2]==='Floor 1') f1.innerHTML += item;
            else if(r[2]==='Floor 2') f2.innerHTML += item;
            else fb.innerHTML += item;
        }
    });
}
</script>
</body>
</html>
