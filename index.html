<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System v8.0 Pro</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #0f172a; --secondary: #334155; --accent: #2563eb; --success: #10b981; --danger: #ef4444; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 16px; }
        
        /* Navigation */
        .app-header { background: var(--primary); padding: 15px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-pills .nav-link { color: #94a3b8; font-weight: 600; padding: 10px 20px; border-radius: 8px; transition: 0.3s; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        .nav-pills .nav-link:hover:not(.active) { background: rgba(255,255,255,0.1); color: white; }
        
        /* Cards & UI */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background: white; margin-bottom: 20px; }
        .btn { border-radius: 8px; padding: 10px 20px; font-weight: 600; transition: transform 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        
        /* Status Badges */
        .status-badge { padding: 6px 12px; border-radius: 50px; font-size: 0.85em; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .st-pass { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .st-fail { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* --- NEW PREVIEW MODAL STYLES --- */
        .modal-content { border: none; border-radius: 16px; overflow: hidden; }
        .modal-header { background: var(--primary); color: white; padding: 20px 30px; border-bottom: none; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-bottom: 4px solid transparent; height: 100%; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.8; }
        .stat-title { color: #64748b; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .stat-sub { font-size: 0.85rem; color: #94a3b8; }
        
        /* Stat Card Colors */
        .b-blue { border-color: var(--accent); } .b-blue .stat-icon { color: var(--accent); }
        .b-green { border-color: var(--success); } .b-green .stat-icon { color: var(--success); }
        .b-red { border-color: var(--danger); } .b-red .stat-icon { color: var(--danger); }
        .b-dark { border-color: var(--secondary); } .b-dark .stat-icon { color: var(--secondary); }

        /* Preview Table */
        .pro-table thead { background: #f8fafc; color: #475569; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
        .pro-table th, .pro-table td { padding: 12px 15px; vertical-align: middle; }
        .pro-table .total-row { background: var(--primary) !important; color: white; font-weight: bold; font-size: 1.1em; }
        
        .edit-active { background-color: #fffbeb !important; border: 2px dashed #f59e0b !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-dark">Syncing Data...</div>
</div>

<!-- Header -->
<div class="app-header no-print d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
        <div class="bg-white rounded-circle p-1"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 40px;"></div>
        <h5 class="m-0 fw-bold text-white tracking-wide">PDI MASTER <span style="color: var(--accent);">PRO</span></h5>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)"><i class="bi bi-pencil-square me-2"></i>Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard', this)"><i class="bi bi-graph-up me-2"></i>Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure', this)"><i class="bi bi-check2-circle me-2"></i>Closure</button>
    </div>
</div>

<div class="container-fluid mt-4 px-4">
    
    <!-- ENTRY TAB -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex" value="">
            
            <!-- Date & Add Button -->
            <div class="card p-4" id="formCard">
                <div class="row g-4 align-items-end">
                    <div class="col-md-3">
                        <label class="fw-bold text-muted small mb-1">SELECT DATE</label>
                        <input type="date" id="entryDate" class="form-control form-control-lg fw-bold" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-outline-primary btn-lg" id="addRowBtn" onclick="addLotRow()">
                            <i class="bi bi-plus-lg me-2"></i>Add Line Item
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Table -->
            <div class="card mt-3 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0 text-center table-hover" style="min-width: 1300px;">
                        <thead class="table-light text-secondary small">
                            <tr>
                                <th width="8%">LINE</th><th width="15%">MODEL</th><th width="12%">COLOUR</th>
                                <th width="12%">LOT ID</th><th width="8%">QTY</th><th width="10%">STATUS</th>
                                <th width="10%">RESULT</th><th>DEFECT / REMARKS</th><th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-3 mt-4 mb-5">
                <button type="button" class="btn btn-lg btn-light border px-4" onclick="resetForm()">Cancel</button>
                <button type="submit" id="saveBtn" class="btn btn-lg btn-primary px-5 shadow-sm">
                    <i class="bi bi-cloud-upload me-2"></i>SAVE RECORDS
                </button>
            </div>
        </form>

        <!-- Recent Records & Filter -->
        <div class="card">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-bottom">
                <span class="fw-bold text-secondary"><i class="bi bi-clock-history me-2"></i>Recent Entries</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control form-control-sm w-auto" onchange="renderRecentTable()">
                    <button class="btn btn-sm btn-dark px-3" onclick="showDaySummary()"><i class="bi bi-eye me-2"></i>Preview Report</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle mb-0">
                    <thead class="table-dark">
                        <tr><th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="crudTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DASHBOARD TAB -->
    <div id="tab-dashboard" style="display:none;">
        <div class="card p-4 mb-4 no-print">
            <div class="row g-3 align-items-end">
                <div class="col-md-3"><label class="fw-bold small">From Date</label><input type="date" id="dashFrom" class="form-control"></div>
                <div class="col-md-3"><label class="fw-bold small">To Date</label><input type="date" id="dashTo" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="runDashboardAnalysis()">Apply Filter</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger" onclick="downloadPDF()"><i class="bi bi-file-earmark-pdf me-2"></i>Export PDF</button></div>
            </div>
        </div>
        <div id="pdf-content">
            <div class="row g-4 mb-4 text-center">
                <div class="col-md-3"><div class="stat-card b-dark"><i class="bi bi-box-seam stat-icon"></i><div class="stat-val" id="d_lots">0</div><div class="stat-title">Total Lots</div></div></div>
                <div class="col-md-3"><div class="stat-card b-blue"><i class="bi bi-layers stat-icon"></i><div class="stat-val" id="d_qty">0</div><div class="stat-title">Total Qty</div></div></div>
                <div class="col-md-3"><div class="stat-card b-green"><i class="bi bi-check-circle stat-icon"></i><div class="stat-val" id="d_lar">0%</div><div class="stat-title">LAR %</div></div></div>
                <div class="col-md-3"><div class="stat-card b-green"><i class="bi bi-pie-chart stat-icon"></i><div class="stat-val" id="d_pass">0%</div><div class="stat-title">Pass Rate</div></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-12"><div class="card p-3"><div id="ch_trend" style="height:350px"></div></div></div>
                <div class="col-md-6"><div class="card p-3"><div id="ch_line" style="height:300px"></div></div></div>
                <div class="col-md-6"><div class="card p-3"><div id="ch_floor" style="height:300px"></div></div></div>
            </div>
        </div>
    </div>

    <!-- CLOSURE TAB -->
    <div id="tab-closure" style="display:none;">
        <div class="alert alert-warning border-warning d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div><strong>Action Items:</strong> These lots require immediate attention or rework.</div>
        </div>
        <div class="row g-4">
            <div class="col-md-4"><div class="card h-100"><div class="card-header bg-light fw-bold text-center">Floor 1 Pending</div><div class="card-body" id="list_f1"></div></div></div>
            <div class="col-md-4"><div class="card h-100"><div class="card-header bg-light fw-bold text-center">Floor 2 Pending</div><div class="card-body" id="list_f2"></div></div></div>
            <div class="col-md-4"><div class="card h-100"><div class="card-header bg-light fw-bold text-center">Basement Pending</div><div class="card-body" id="list_fb"></div></div></div>
        </div>
    </div>
</div>

<!-- PROFESSIONAL PREVIEW MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-white rounded p-1"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 35px;"></div>
                    <div>
                        <h5 class="m-0 fw-bold">Daily Production Summary</h5>
                        <small class="text-white-50" id="previewDateDisplay">Date: --/--/----</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="summaryBody"></div>
            <div class="modal-footer bg-white">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" onclick="window.print()">Print Report</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycbyvBKmQ9GDPwPJXiSBh7En0YPTrJ3uemT7T6nlx-j9EGLJI6fPHXGRhExla4ImSfFyf/exec";
const MODELS = ["Unity ANC","Ace","111v2","131 Elite Anc","131 Gen 2","141 Anc","161 Anc","161 N","181 Pro","191 Anc","192","212","280 Anc","300","71","800","91","Ace Gen 2","Hype","Kick","Nirvana Crystal","Nirvana Iris","Nirvana X","Plus 311","Prime 412","Primo","Pulse","Supreme","Ultra Pro","100","121 Pro","131","141","161","161 Pro-Buds","181","190","191 G","207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","HMD P50","HMD S60","HMD X50","IMT 100","IMT121","IMT131","IMT161","Joy","Max","Nirvana","Nirvana Ion","R 195 Pro","Ultra Plus","Zing"];
const COLOURS = ["Black","Blue","Bold Blue","Crimson Cream","Graphite Grey","Ivory White","Krypton Blue","Lavender Rush","Moon White","Pine Green","Space Grey","Sterling Silver","White","Zinc White","Active Black","Active Teal","Aqua Blue","Ash Grey","Assassin Black","Azure Blue","Berry Blue","Carbon Black","Charcoal Black","Cherry Blossom","Cool Grey","Cosmic Onyx","Cream White","Crimsom Red","Crystal Black","Cyan cider","Deep Blue","Electric Blue","Emerald Green","Frost White","Galactic Purple","Gunmetal Black","Ice Blue","Ivory","Jet Black","Lunar White","Maroon Lush","Martian Green","Metallic Grey","Midnight Black","Midnight Blue","Mint Blue","Mist Grey","Mystic Blue","Noir Black","Ocean Blue","Olive Green","Opal Black","Orange","Peach Blush","Pearl White","Pellucid Blue","Purple","Quantum Black","Red","Rose Quartz","Saga Green","Sandstone","Shadow Black","Silver","Slate Grey","Sleek Black","Sonic Silver","Spirit White","Sporty Blue","Starry Blue","Sunset Blush","Teal","Thunder Blue","Velvet Rouge","Yellow Pop"];

let sheetData = [];
google.charts.load('current', {'packages':['corechart']});

window.onload = function() {
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    document.getElementById('dashFrom').value = today;
    document.getElementById('dashTo').value = today;
    addLotRow();
    loadAllData();
};

function switchTab(tab, btn) {
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
    if(tab === 'dashboard') runDashboardAnalysis();
    if(tab === 'closure') runClosureReport();
}

function getLocalISO(dt) { return new Date(dt).toISOString().split('T')[0]; }

async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0] && sheetData[0][0] === "Date") sheetData.shift(); // Remove header
        renderRecentTable();
    } catch(e) { console.error(e); }
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const fDate = document.getElementById('recentFilter').value;
    tb.innerHTML = "";
    sheetData.filter(r => getLocalISO(r[0]) === fDate).reverse().forEach(r => {
        let idx = sheetData.indexOf(r);
        let statusClass = r[8] === 'Pass' ? 'st-pass' : 'st-fail';
        tb.innerHTML += `<tr>
            <td>${new Date(r[0]).toLocaleDateString()}</td><td>L${r[1]}</td><td>${r[3]}</td><td class="fw-bold text-dark">${r[5]}</td><td>${r[6]}</td>
            <td><span class="status-badge ${statusClass}">${r[8]}</span></td>
            <td>
                <button class="btn btn-light border btn-sm text-warning" onclick="editRec(${idx})"><i class="bi bi-pencil-fill"></i></button>
                <button class="btn btn-light border btn-sm text-danger" onclick="deleteRec(${idx})"><i class="bi bi-trash-fill"></i></button>
            </td>
        </tr>`;
    });
}

// --- UPDATED PREVIEW FUNCTION WITH TOTAL ROW ---
function showDaySummary() {
    const fDate = document.getElementById('recentFilter').value;
    document.getElementById('previewDateDisplay').innerText = "Report Date: " + new Date(fDate).toDateString();
    
    let dayData = sheetData.filter(r => getLocalISO(r[0]) === fDate);
    if(!dayData.length) return alert("No data found for selected date!");

    let pLots=0, fLots=0, tQty=0, pQty=0;
    // Initialise floors with order
    let floors = {
        "Floor 1": {tQ:0, pQ:0, tL:0, pL:0}, 
        "Floor 2": {tQ:0, pQ:0, tL:0, pL:0}, 
        "Basement": {tQ:0, pQ:0, tL:0, pL:0}
    };
    let rejects = [];

    dayData.forEach(r => {
        let q = parseInt(r[6]||0), fl = r[2] || "Floor 1";
        if(!floors[fl]) floors[fl] = {tQ:0, pQ:0, tL:0, pL:0}; // Safety

        tQty += q; floors[fl].tQ += q; floors[fl].tL++;
        if(r[8]==='Pass') { 
            pLots++; pQty += q; 
            floors[fl].pL++; floors[fl].pQ += q; 
        } else { 
            fLots++; rejects.push(r); 
        }
    });

    let passRate = tQty > 0 ? ((pQty / tQty) * 100).toFixed(2) : "0.00";
    
    // --- CALCULATE GRAND TOTALS FOR TABLE ---
    let total_Lots = 0, total_PassL = 0, total_Qty = 0, total_PassQ = 0;
    Object.keys(floors).forEach(f => {
        total_Lots += floors[f].tL;
        total_PassL += floors[f].pL;
        total_Qty += floors[f].tQ;
        total_PassQ += floors[f].pQ;
    });
    let total_Rate = total_Qty > 0 ? ((total_PassQ / total_Qty) * 100).toFixed(2) : "0.00";

    // --- GENERATE HTML ---
    let html = `
        <!-- KPI Cards -->
        <div class="row g-4 mb-5 mt-2">
            <div class="col-md-3">
                <div class="stat-card b-dark">
                    <i class="bi bi-clipboard-data stat-icon"></i>
                    <div class="stat-title">Total Production</div>
                    <div class="stat-value">${pLots+fLots} <span class="fs-6 text-muted">Lots</span></div>
                    <div class="stat-sub">Units: ${tQty}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card b-green">
                    <i class="bi bi-check-circle-fill stat-icon"></i>
                    <div class="stat-title">Passed Lots</div>
                    <div class="stat-value text-success">${pLots}</div>
                    <div class="stat-sub">Units: ${pQty}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card b-red">
                    <i class="bi bi-x-octagon-fill stat-icon"></i>
                    <div class="stat-title">Rejected Lots</div>
                    <div class="stat-value text-danger">${fLots}</div>
                    <div class="stat-sub">Units: ${tQty-pQty}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card b-blue">
                    <i class="bi bi-pie-chart-fill stat-icon"></i>
                    <div class="stat-title">Overall Pass Rate</div>
                    <div class="stat-value text-primary">${passRate}%</div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar" style="width: ${passRate}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floor Table -->
        <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-table me-2"></i>FLOOR WISE PERFORMANCE</h6>
        <div class="card shadow-sm border-0 mb-5">
            <table class="table pro-table mb-0 text-center table-bordered">
                <thead>
                    <tr>
                        <th class="bg-light">Floor Name</th>
                        <th>Total Lots</th>
                        <th>Passed Lots</th>
                        <th>Total Qty</th>
                        <th>Passed Qty</th>
                        <th>Pass Rate %</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(floors).map(f => {
                        let rate = floors[f].tQ ? ((floors[f].pQ/floors[f].tQ)*100).toFixed(2) : "0.00";
                        return `<tr>
                            <td class="fw-bold text-start ps-4">${f}</td>
                            <td>${floors[f].tL}</td>
                            <td>${floors[f].pL}</td>
                            <td>${floors[f].tQ}</td>
                            <td>${floors[f].pQ}</td>
                            <td><span class="badge ${rate>=90?'bg-success':(rate>=80?'bg-warning text-dark':'bg-danger')}">${rate}%</span></td>
                        </tr>`;
                    }).join('')}
                </tbody>
                <!-- ADDED TOTAL ROW HERE -->
                <tfoot class="total-row">
                    <tr>
                        <td class="text-start ps-4">GRAND TOTAL</td>
                        <td>${total_Lots}</td>
                        <td>${total_PassL}</td>
                        <td>${total_Qty}</td>
                        <td>${total_PassQ}</td>
                        <td>${total_Rate}%</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Rejections Section -->
        <h6 class="fw-bold text-danger mb-3"><i class="bi bi-bug-fill me-2"></i>REJECTED / FAILED LOTS</h6>
        ${rejects.length > 0 ? `
            <div class="card shadow-sm border-0 border-start border-4 border-danger">
                <table class="table table-striped mb-0 align-middle">
                    <thead class="table-danger">
                        <tr><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Defect Remarks</th></tr>
                    </thead>
                    <tbody>
                        ${rejects.map(r => `<tr>
                            <td><b>L${r[1]}</b></td>
                            <td>${r[3]}</td>
                            <td class="text-danger fw-bold">${r[5]}</td>
                            <td>${r[6]}</td>
                            <td class="text-danger text-wrap text-start">${r[9]||"-"}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
        ` : `
            <div class="alert alert-success d-flex align-items-center">
                <i class="bi bi-hand-thumbs-up-fill fs-4 me-3"></i>
                <div><strong>Excellent!</strong> No rejected lots found for this date.</div>
            </div>
        `}
    `;
    
    document.getElementById('summaryBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function addLotRow(data = null) {
    const tr = document.createElement('tr'); tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">L${i}</option>`;
    
    tr.innerHTML = `
        <td><select class="form-select i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control i-id fw-bold text-uppercase" placeholder="ID" required></td>
        <td><input type="number" class="form-control i-qty" placeholder="0" required></td>
        <td><select class="form-select i-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select i-res fw-bold" onchange="toggleRem(this)"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control i-rem" placeholder="Remarks" disabled></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('tr').remove()"><i class="bi bi-x-lg"></i></button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);
    
    if(data) {
        tr.querySelector('.i-line').value = data[1];
        tr.querySelector('.i-model').value = data[3];
        tr.querySelector('.i-color').value = data[4];
        tr.querySelector('.i-id').value = data[5];
        tr.querySelector('.i-qty').value = data[6];
        tr.querySelector('.i-status').value = data[7];
        tr.querySelector('.i-res').value = data[8];
        if(data[8]==='Fail'){ 
            tr.querySelector('.i-rem').disabled=false; 
            tr.querySelector('.i-rem').value=data[9]; 
            tr.querySelector('.i-res').style.color = 'var(--danger)';
        } else {
             tr.querySelector('.i-res').style.color = 'var(--success)';
        }
    }
}

function toggleRem(sel) {
    const row = sel.closest('tr');
    const rem = row.querySelector('.i-rem');
    if(sel.value === 'Fail') {
        rem.disabled = false;
        rem.focus();
        sel.style.color = 'var(--danger)';
    } else {
        rem.disabled = true;
        rem.value = "";
        sel.style.color = 'var(--success)';
    }
}

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    const editIdx = document.getElementById('editRowIndex').value;
    document.getElementById('loader').style.display='flex';
    
    let rows = [];
    document.querySelectorAll('.input-row').forEach(tr => {
        let l = parseInt(tr.querySelector('.i-line').value);
        let floor = (l <= 8) ? "Floor 1" : (l <= 16 ? "Floor 2" : "Basement");
        
        rows.push([
            document.getElementById('entryDate').value, 
            l, 
            floor, 
            tr.querySelector('.i-model').value, 
            tr.querySelector('.i-color').value, 
            tr.querySelector('.i-id').value.toUpperCase(), 
            tr.querySelector('.i-qty').value, 
            tr.querySelector('.i-status').value, 
            tr.querySelector('.i-res').value, 
            tr.querySelector('.i-rem').value||""
        ]);
    });

    let payload = (editIdx && editIdx !== "") ? { action: 'edit', rowIndex: parseInt(editIdx), data: rows[0] } : { action: 'save', data: rows };

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        resetForm(); await loadAllData();
        alert("Data Saved Successfully!");
    } catch (err) { alert("Error saving data"); }
    document.getElementById('loader').style.display='none';
};

async function deleteRec(idx) {
    if(!confirm("Are you sure you want to delete this record?")) return;
    document.getElementById('loader').style.display='flex';
    await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex: idx + 2})});
    await loadAllData();
}

function editRec(idx) {
    const r = sheetData[idx];
    document.getElementById('editRowIndex').value = (idx + 2);
    document.getElementById('entryDate').value = getLocalISO(r[0]);
    document.getElementById('lotContainer').innerHTML=""; addLotRow(r);
    
    const sBtn = document.getElementById('saveBtn');
    sBtn.innerHTML = '<i class="bi bi-check2-all me-2"></i>UPDATE RECORD';
    sBtn.className = "btn btn-lg btn-warning px-5 shadow-sm text-dark fw-bold";
    document.getElementById('formCard').className="card p-4 edit-active";
    document.getElementById('addRowBtn').style.display = 'none';
    window.scrollTo(0,0);
}

function resetForm() {
    document.getElementById('pdiForm').reset();
    document.getElementById('editRowIndex').value = "";
    document.getElementById('lotContainer').innerHTML = ""; addLotRow();
    
    const sBtn = document.getElementById('saveBtn');
    sBtn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>SAVE RECORDS';
    sBtn.className = "btn btn-lg btn-primary px-5 shadow-sm";
    
    document.getElementById('formCard').className = "card p-4";
    document.getElementById('addRowBtn').style.display = 'inline-block';
}

function runDashboardAnalysis() {
    // Basic chart implementation kept same, styled via CSS
    const from = document.getElementById('dashFrom').value, to = document.getElementById('dashTo').value;
    let dLots=0, dQty=0, pLots=0, pQty=0;
    let dates={}; 

    sheetData.forEach(r => {
        let rd = getLocalISO(r[0]);
        if(rd >= from && rd <= to) {
            let q = parseInt(r[6]||0);
            dLots++; dQty += q; 
            if(!dates[rd]) dates[rd] = {p:0, t:0};
            dates[rd].t += q;
            if(r[8] === 'Pass') { pLots++; pQty += q; dates[rd].p += q; }
        }
    });

    document.getElementById('d_lots').innerText = dLots; 
    document.getElementById('d_qty').innerText = dQty;
    document.getElementById('d_lar').innerText = dLots ? (pLots/dLots*100).toFixed(1)+"%" : "0%";
    document.getElementById('d_pass').innerText = dQty ? (pQty/dQty*100).toFixed(1)+"%" : "0%";

    // Draw simple chart
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Date');
    data.addColumn('number', 'Pass Rate');
    Object.keys(dates).sort().forEach(d => {
        data.addRow([d.substr(5), (dates[d].t ? (dates[d].p/dates[d].t)*100 : 0)]);
    });

    new google.visualization.AreaChart(document.getElementById('ch_trend')).draw(data, {
        title: 'Pass Rate Trend', colors:['#2563eb'], 
        vAxis:{minValue:0, maxValue:100}, legend: 'none',
        areaOpacity: 0.1
    });
}
</script>
</body>
</html>
