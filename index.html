<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Performance Report</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        
        /* HEADER */
        .app-header { background: white; border-bottom: 4px solid #003366; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .logo { height: 50px; }
        .app-title { color: #003366; font-weight: 800; font-size: 22px; text-transform: uppercase; margin: 0; }

        /* CARDS & LAYOUT */
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { background: #003366; color: white; font-weight: bold; padding: 10px 15px; }
        
        /* DATA ENTRY TABLE */
        .lot-table th { background: #e9ecef; text-align: center; vertical-align: middle; font-size: 13px; }
        .lot-table td { vertical-align: top; padding: 8px; }
        
        /* DASHBOARD */
        .kpi-box { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #003366; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .kpi-val { font-size: 28px; font-weight: bold; color: #333; }
        .kpi-lbl { font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold; }
        
        /* CHART BOXES */
        .chart-container { height: 350px; width: 100%; }

        /* LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #003366; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="loader">Syncing with Google Sheets...</div>

<!-- Header -->
<div class="app-header">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h1 class="app-title">PDI Performance Report</h1>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active btn btn-outline-primary" onclick="switchTab('form')">üìù Data Entry</button>
        <button class="nav-link btn btn-outline-primary ms-2" onclick="switchTab('dashboard')">üìä Dashboard & Analysis</button>
    </div>
</div>

<div class="container-fluid mt-3" style="padding-bottom:80px;">

    <!-- 1. DATA ENTRY TAB -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex"> 
            
            <!-- Master Info -->
            <div class="card">
                <div class="card-header">General Information</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="fw-bold">Date</label>
                            <input type="date" id="date" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold">Line (Floor Auto-Detect)</label>
                            <select id="line" class="form-select" onchange="detectFloor()" required>
                                <option value="">Select Line</option>
                            </select>
                            <small class="text-primary fw-bold" id="floorDisplay">--</small>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold">Model</label>
                            <select id="model" class="form-select"><option>Model A</option><option>Model B</option></select>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold">Color</label>
                            <select id="color" class="form-select"><option>Black</option><option>White</option><option>Blue</option></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multiple Lots Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Lot Details (Multiple)</span>
                    <button type="button" class="btn btn-sm btn-light fw-bold text-dark" onclick="addLotRow()">+ Add Lot</button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered lot-table mb-0">
                        <thead>
                            <tr>
                                <th width="10%">Lot ID</th>
                                <th width="10%">Qty</th>
                                <th width="12%">Status</th>
                                <th width="12%">Result</th>
                                <th>Defect Details (If Fail)</th>
                                <th width="5%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <div class="text-end">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
                <button type="submit" class="btn btn-success px-5 ms-2">Save to Sheet</button>
            </div>
        </form>

        <!-- Records Table (CRUD) -->
        <div class="card mt-4">
            <div class="card-header">Existing Records</div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-striped table-sm text-center align-middle mb-0">
                        <thead class="table-dark" style="position: sticky; top: 0;">
                            <tr><th>Date</th><th>Line</th><th>Lot ID</th><th>Result</th><th>Defect</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="crudTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. DASHBOARD TAB -->
    <div id="tab-dashboard" style="display:none;">
        
        <!-- Filters & Action -->
        <div class="card p-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-3"><label>From</label><input type="date" id="dashStart" class="form-control"></div>
                <div class="col-md-3"><label>To</label><input type="date" id="dashEnd" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="loadDashboard()">Load Data</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger" onclick="downloadPPT()"><i class="bi bi-file-ppt"></i> Download Report (PPT)</button></div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-lbl">Total Lots</div><div class="kpi-val" id="kpi_lots">0</div></div></div>
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-lbl">Total Qty</div><div class="kpi-val" id="kpi_qty">0</div></div></div>
            <div class="col-md-3"><div class="kpi-box" style="border-color:#28a745"><div class="kpi-lbl">LAR % (Lot Wise)</div><div class="kpi-val text-success" id="kpi_lar">0%</div></div></div>
            <div class="col-md-3"><div class="kpi-box" style="border-color:#17a2b8"><div class="kpi-lbl">Pass Rate % (Qty Wise)</div><div class="kpi-val text-info" id="kpi_pass">0%</div></div></div>
        </div>

        <!-- Trend Charts -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Date-wise Pass Rate Trend (Qty Base)</div>
                    <div class="card-body"><div id="chart_trend_qty" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Date-wise LAR Trend (Lot Base)</div>
                    <div class="card-body"><div id="chart_trend_lot" class="chart-container"></div></div>
                </div>
            </div>
        </div>

        <!-- Floor Wise Charts -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Floor Wise Performance (Qty Pass Rate %)</div>
                    <div class="card-body"><div id="chart_floor_pass" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Floor Wise LAR % (Lot Base)</div>
                    <div class="card-body"><div id="chart_floor_lar" class="chart-container"></div></div>
                </div>
            </div>
        </div>

        <!-- Defect Analysis & Action Plan -->
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Top 5 Defects (Pareto)</div>
                    <div class="card-body"><div id="chart_pareto" class="chart-container"></div></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">Action Plan (Top 5 Defects)</div>
                    <div class="card-body">
                        <table class="table table-bordered table-sm" style="font-size:12px;">
                            <thead class="table-light"><tr><th>Defect</th><th>Qty</th><th>Root Cause & Action</th></tr></thead>
                            <tbody id="actionPlanBody"></tbody>
                        </table>
                        <label class="fw-bold mt-2">Overall Remarks:</label>
                        <textarea id="overallRemarks" class="form-control" rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="previewContent"></div>
        </div>
    </div>
</div>

<script>
// ===========================================
// CONFIGURATION
// ===========================================
// ‚ö†Ô∏è Replace with your Google Apps Script URL
const API_URL = "https://script.google.com/macros/s/AKfycbyKy7X0OWvjeMSVpM36HGH3fVE_XQQ8alDUbhh1msX9gjVPHBtGvdvgkuOefSGfSRX7/exec"; 

let sheetData = []; 
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = function() {
    let ls = document.getElementById('line');
    for(let i=1;i<=21;i++) ls.add(new Option(i,i));
    
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('dashStart').value = today;
    document.getElementById('dashEnd').value = today;

    addLotRow();
    loadDashboard();
};

function switchTab(tab){
    document.getElementById('tab-form').style.display = tab==='form'?'block':'none';
    document.getElementById('tab-dashboard').style.display = tab==='dashboard'?'block':'none';
    document.querySelector('.nav-link.active').classList.remove('active');
    event.target.classList.add('active');
}

function detectFloor(){
    let l = parseInt(document.getElementById('line').value||0);
    let f = (l>=1 && l<=8) ? "Floor 1" : (l>=9 && l<=16) ? "Floor 2" : (l>=17) ? "Basement" : "--";
    document.getElementById('floorDisplay').innerText = f;
    return f;
}

// ===========================================
// FORM HANDLING (Multiple Lots)
// ===========================================
function addLotRow(data = null){
    const tbody = document.getElementById('lotContainer');
    const tr = document.createElement('tr');
    tr.className = 'lot-row';
    tr.innerHTML = `
        <td><input type="text" class="form-control form-control-sm l-id" placeholder="Lot ID" required></td>
        <td><input type="number" class="form-control form-control-sm l-qty" placeholder="Qty" required></td>
        <td><select class="form-select form-select-sm l-status"><option>Fresh</option><option>Rework</option><option>Warranty</option><option>Market Rework</option></select></td>
        <td>
            <select class="form-select form-select-sm l-result fw-bold" onchange="toggleDefect(this)">
                <option value="Pass" style="color:green">Pass</option>
                <option value="Fail" style="color:red">Fail</option>
                <option value="Hold" style="color:orange">Hold</option>
            </select>
        </td>
        <td>
            <div class="defect-details" style="display:none;">
                <div class="input-group input-group-sm mb-1">
                    <input type="text" class="form-control d-name" placeholder="Defect Name">
                    <input type="number" class="form-control d-qty" placeholder="Qty">
                </div>
                <div class="input-group input-group-sm mb-1">
                    <select class="form-select d-stage"><option>LQC</option><option>FT</option><option>Packing</option></select>
                    <select class="form-select d-belong"><option>Earbuds</option><option>Case</option></select>
                </div>
                <input type="text" class="form-control form-control-sm d-ana" placeholder="Analysis">
            </div>
            <span class="text-success small fw-bold pass-msg">No Defect</span>
        </td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">X</button></td>
    `;
    tbody.appendChild(tr);

    if(data){
        // Prefill logic for edit (Single row mode)
        tr.querySelector('.l-id').value = data[5];
        tr.querySelector('.l-qty').value = data[6];
        tr.querySelector('.l-status').value = data[7];
        tr.querySelector('.l-result').value = data[8];
        toggleDefect(tr.querySelector('.l-result'));
        if(data[8]==='Fail'){
            tr.querySelector('.d-name').value = data[9];
            tr.querySelector('.d-qty').value = data[10];
            tr.querySelector('.d-stage').value = data[11];
            tr.querySelector('.d-belong').value = "Earbuds"; // Default or parse from data if saved
            tr.querySelector('.d-ana').value = data[12];
        }
    }
}

function toggleDefect(sel){
    let cell = sel.closest('td').nextElementSibling;
    if(sel.value === 'Fail'){
        cell.querySelector('.defect-details').style.display='block';
        cell.querySelector('.pass-msg').style.display='none';
    } else {
        cell.querySelector('.defect-details').style.display='none';
        cell.querySelector('.pass-msg').style.display='block';
    }
}

document.getElementById('pdiForm').addEventListener('submit', async function(e){
    e.preventDefault();
    if(!API_URL.includes("script.google.com")){ alert("Setup API URL first"); return; }
    
    document.getElementById('loader').style.display='flex';
    
    // Header Data
    let date = document.getElementById('date').value;
    let line = document.getElementById('line').value;
    let floor = document.getElementById('floorDisplay').innerText;
    let model = document.getElementById('model').value;
    let color = document.getElementById('color').value;

    let rowsToSave = [];
    document.querySelectorAll('.lot-row').forEach(tr => {
        let res = tr.querySelector('.l-result').value;
        let dName = res==='Fail' ? tr.querySelector('.d-name').value : "";
        let dQty = res==='Fail' ? tr.querySelector('.d-qty').value : 0;
        let dStage = res==='Fail' ? tr.querySelector('.d-stage').value : "";
        let dAna = res==='Fail' ? tr.querySelector('.d-ana').value : "";

        // Structure: [Date, Line, Floor, Model, Color, LotID, Qty, Status, Result, DefectName, DefectQty, Stage, Analysis]
        rowsToSave.push([
            date, line, floor, model, color,
            tr.querySelector('.l-id').value.toUpperCase(),
            tr.querySelector('.l-qty').value,
            tr.querySelector('.l-status').value,
            res, dName, dQty, dStage, dAna
        ]);
    });

    let editIdx = document.getElementById('editRowIndex').value;
    let payload = { action: "save", data: rowsToSave };
    
    if(editIdx){
        // In Edit mode, we usually edit one row at a time from the table
        payload = { action: "edit", rowIndex: editIdx, data: rowsToSave[0] };
    }

    try{
        await fetch(API_URL, {method:'POST', body:JSON.stringify(payload)});
        alert("Saved Successfully");
        resetForm();
        loadDashboard();
    } catch(err){ console.error(err); alert("Save Failed"); }
    finally{ document.getElementById('loader').style.display='none'; }
});

function resetForm(){
    document.getElementById('pdiForm').reset();
    document.getElementById('lotContainer').innerHTML = "";
    document.getElementById('editRowIndex').value = "";
    addLotRow();
}

// ===========================================
// DASHBOARD LOGIC (Charts & Stats)
// ===========================================
async function loadDashboard(){
    if(!API_URL.includes("script.google.com")) return;
    document.getElementById('loader').style.display='flex';
    
    try {
        let res = await fetch(API_URL);
        let json = await res.json();
        sheetData = json.data;
        // Remove header if present
        if(sheetData.length && sheetData[0][0] === "Date") sheetData.shift();

        processDashboardData();
        renderCrudTable();
    } catch(e) { console.error(e); }
    finally { document.getElementById('loader').style.display='none'; }
}

function processDashboardData(){
    let start = document.getElementById('dashStart').value;
    let end = document.getElementById('dashEnd').value;
    
    // Filter by Date
    let data = sheetData.filter(r => r[0] >= start && r[0] <= end);

    // Aggregators
    let totalLots=0, passLots=0;
    let totalQty=0, passQty=0;
    
    let dateStats = {}; // { date: { lots, pLots, qty, pQty } }
    let floorStats = { "Floor 1": {l:0, pl:0, q:0, pq:0}, "Floor 2": {l:0, pl:0, q:0, pq:0}, "Basement": {l:0, pl:0, q:0, pq:0} };
    let defectCounts = {};

    data.forEach(r => {
        let date = r[0].split('T')[0];
        let floor = r[2]; // Floor column
        if(!floorStats[floor]) floor = "Floor 1"; // Fallback
        
        let qty = parseInt(r[6]||0);
        let res = r[8];
        let dQty = parseInt(r[10]||0);

        // Global Stats
        totalLots++;
        totalQty += qty;
        
        // Init Date Stats
        if(!dateStats[date]) dateStats[date] = {l:0, pl:0, q:0, pq:0};

        // Increment Totals (Date/Floor)
        dateStats[date].l++; floorStats[floor].l++;
        dateStats[date].q += qty; floorStats[floor].q += qty;

        if(res === 'Pass'){
            passLots++;
            passQty += qty;
            
            dateStats[date].pl++; floorStats[floor].pl++;
            dateStats[date].pq += qty; floorStats[floor].pq += qty;
        } else {
            // Fail
            let okQty = qty - dQty; // Partial pass qty
            passQty += okQty;
            dateStats[date].pq += okQty; floorStats[floor].pq += okQty;

            // Defect Pareto
            let dName = r[9];
            if(dName){
                if(!defectCounts[dName]) defectCounts[dName]=0;
                defectCounts[dName] += dQty;
            }
        }
    });

    // 1. UPDATE KPIs
    document.getElementById('kpi_lots').innerText = totalLots;
    document.getElementById('kpi_qty').innerText = totalQty;
    let lar = totalLots ? (passLots/totalLots*100).toFixed(2) : 0;
    let pr = totalQty ? (passQty/totalQty*100).toFixed(2) : 0;
    document.getElementById('kpi_lar').innerText = lar + "%";
    document.getElementById('kpi_pass').innerText = pr + "%";

    // 2. TREND CHARTS
    let dateArr = Object.keys(dateStats).sort();
    let trendQtyData = [['Date', 'Pass Rate %']];
    let trendLotData = [['Date', 'LAR %']];
    
    dateArr.forEach(d => {
        let s = dateStats[d];
        trendQtyData.push([d, s.q ? (s.pq/s.q*100) : 0]);
        trendLotData.push([d, s.l ? (s.pl/s.l*100) : 0]);
    });
    drawLineChart('chart_trend_qty', trendQtyData, 'Qty Pass Rate Trend');
    drawLineChart('chart_trend_lot', trendLotData, 'Lot LAR Trend', '#28a745');

    // 3. FLOOR CHARTS
    let floorArr = ["Floor 1", "Floor 2", "Basement"];
    let floorPassData = [['Floor', 'Pass Rate %']];
    let floorLarData = [['Floor', 'LAR %']];
    
    floorArr.forEach(f => {
        let s = floorStats[f];
        floorPassData.push([f, s.q ? (s.pq/s.q*100) : 0]);
        floorLarData.push([f, s.l ? (s.pl/s.l*100) : 0]);
    });
    drawBarChart('chart_floor_pass', floorPassData, 'Floor Pass Rate', '#17a2b8');
    drawBarChart('chart_floor_lar', floorLarData, 'Floor LAR', '#ffc107');

    // 4. PARETO & ACTION PLAN
    let sortedDefects = Object.keys(defectCounts).map(k => ({name:k, qty:defectCounts[k]})).sort((a,b)=>b.qty-a.qty);
    let top5 = sortedDefects.slice(0, 5);
    
    let paretoData = [['Defect', 'Qty']];
    let actionHtml = "";
    
    if(top5.length === 0) {
        paretoData.push(['No Defects', 0]);
        actionHtml = "<tr><td colspan='3'>No Defects</td></tr>";
    } else {
        top5.forEach(d => {
            paretoData.push([d.name, d.qty]);
            actionHtml += `<tr><td>${d.name}</td><td>${d.qty}</td><td><input type="text" class="form-control form-control-sm act-input" placeholder="Plan..."></td></tr>`;
        });
    }
    drawBarChart('chart_pareto', paretoData, 'Top 5 Defects', '#dc3545');
    document.getElementById('actionPlanBody').innerHTML = actionHtml;
}

function drawLineChart(id, data, title, color='#003366'){
    if(data.length < 2) data.push(['', 0]);
    let dt = google.visualization.arrayToDataTable(data);
    let opt = { title: title, legend:{position:'none'}, colors:[color], pointSize:5, vAxis:{minValue:0, maxValue:100} };
    new google.visualization.LineChart(document.getElementById(id)).draw(dt, opt);
}

function drawBarChart(id, data, title, color='#003366'){
    let dt = google.visualization.arrayToDataTable(data);
    let opt = { title: title, legend:{position:'none'}, colors:[color], vAxis:{minValue:0} };
    new google.visualization.ColumnChart(document.getElementById(id)).draw(dt, opt);
}

// ===========================================
// CRUD TABLE & PPT
// ===========================================
function renderCrudTable(){
    const tb = document.getElementById('crudTable');
    tb.innerHTML = "";
    // Show last 50
    let recent = sheetData.slice(-50).reverse();
    recent.forEach(r => {
        // Find original index in sheetData
        let realIdx = sheetData.indexOf(r); 
        let html = `<tr>
            <td>${r[0]}</td><td>Line ${r[1]}</td><td><b>${r[5]}</b></td>
            <td class="${r[8]==='Pass'?'text-success':'text-danger'} fw-bold">${r[8]}</td>
            <td>${r[9]||'-'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="previewRow(${realIdx})">üëÅÔ∏è</button>
                <button class="btn btn-sm btn-warning" onclick="editRow(${realIdx})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="delRow(${realIdx})">üóëÔ∏è</button>
            </td>
        </tr>`;
        tb.innerHTML += html;
    });
}

function previewRow(idx){
    let r = sheetData[idx];
    let html = `<ul class="list-group">
        <li class="list-group-item"><b>Date:</b> ${r[0]}</li>
        <li class="list-group-item"><b>Location:</b> Line ${r[1]} (${r[2]})</li>
        <li class="list-group-item"><b>Model:</b> ${r[3]} (${r[4]})</li>
        <li class="list-group-item"><b>Lot:</b> ${r[5]} (Qty: ${r[6]})</li>
        <li class="list-group-item"><b>Result:</b> ${r[8]}</li>
        <li class="list-group-item"><b>Defect:</b> ${r[9]} (${r[10]})</li>
        <li class="list-group-item"><b>Analysis:</b> ${r[12]}</li>
    </ul>`;
    document.getElementById('previewContent').innerHTML = html;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function editRow(idx){
    let r = sheetData[idx];
    switchTab('form');
    document.getElementById('editRowIndex').value = idx;
    
    document.getElementById('date').value = r[0]; // Ensure date format matches yyyy-mm-dd
    document.getElementById('line').value = r[1]; detectFloor();
    document.getElementById('model').value = r[3];
    document.getElementById('color').value = r[4];
    
    document.getElementById('lotContainer').innerHTML = "";
    addLotRow(r); // Pass data to prefill logic inside addLotRow
    window.scrollTo(0,0);
}

async function delRow(idx){
    if(!confirm("Delete this record permanently?")) return;
    document.getElementById('loader').style.display='flex';
    try{
        await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex:idx})});
        loadDashboard();
    } catch(e){ alert("Error"); }
    finally{ document.getElementById('loader').style.display='none'; }
}

function downloadPPT(){
    let pres = new PptxGenJS();
    let logoUrl = "https://i.postimg.cc/5y7SN4xc/logo.png";
    
    // Slide 1: Summary
    let s1 = pres.addSlide();
    s1.addImage({ path: logoUrl, x:0.5, y:0.2, w:1.5, h:0.5 });
    s1.addText("PDI PERFORMANCE REPORT", { x:1, y:1, fontSize:24, color:'003366', bold:true });
    s1.addText(`Period: ${document.getElementById('dashStart').value} to ${document.getElementById('dashEnd').value}`, { x:1, y:1.5, fontSize:14 });
    
    // Stats Table
    let statsData = [
        [{text:"Total Lots", options:{fill:'003366', color:'fff', bold:true}}, {text:"Total Qty", options:{fill:'003366', color:'fff', bold:true}}, {text:"LAR %", options:{fill:'003366', color:'fff', bold:true}}, {text:"Pass Rate %", options:{fill:'003366', color:'fff', bold:true}}],
        [document.getElementById('kpi_lots').innerText, document.getElementById('kpi_qty').innerText, document.getElementById('kpi_lar').innerText, document.getElementById('kpi_pass').innerText]
    ];
    s1.addTable(statsData, {x:1, y:2.5, w:8, align:'center'});

    // Slide 2: Action Plan
    let s2 = pres.addSlide();
    s2.addText("DEFECT ANALYSIS & ACTION PLAN", { x:0.5, y:0.5, fontSize:18, color:'DC3545', bold:true });
    
    // Scrape Action Plan inputs
    let planData = [[{text:"Defect Name", bold:true}, {text:"Qty", bold:true}, {text:"Root Cause & Action", bold:true}]];
    document.querySelectorAll('#actionPlanBody tr').forEach(tr => {
        let tds = tr.querySelectorAll('td');
        if(tds.length){
            let act = tds[2].querySelector('input') ? tds[2].querySelector('input').value : "";
            planData.push([tds[0].innerText, tds[1].innerText, act]);
        }
    });
    
    if(planData.length > 1){
        s2.addTable(planData, {x:0.5, y:1.5, w:9, colW:[3,1.5,4.5]});
    } else {
        s2.addText("No Top Defects found.", {x:1, y:2});
    }

    let remark = document.getElementById('overallRemarks').value;
    if(remark) s2.addText(`Overall Remarks: ${remark}`, {x:0.5, y:5, fontSize:12, color:'333'});

    pres.writeFile({ fileName: "PDI_Report.pptx" });
}
</script>

</body>
</html>
