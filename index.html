<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 15px; }
        
        /* HEADER */
        .app-header { background: white; border-bottom: 5px solid #003366; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .logo { height: 55px; }
        .app-title { color: #003366; font-weight: 800; font-size: 24px; text-transform: uppercase; margin: 0; }

        /* NAV */
        .nav-pills .nav-link { color: #555; font-weight: bold; border: 1px solid #ddd; margin-right: 5px; background: white; }
        .nav-pills .nav-link.active { background-color: #003366; color: white; border-color: #003366; }

        /* CARDS */
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { background: #003366; color: white; font-weight: bold; padding: 12px 15px; border-radius: 8px 8px 0 0 !important; }

        /* TABLES */
        .table thead { background-color: #343a40; color: white; }
        .lot-table th { background: #e9ecef; color: #333; text-align: center; }
        
        /* DASHBOARD BOXES */
        .kpi-box { background: white; padding: 20px; border-radius: 8px; border-left: 6px solid #003366; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .kpi-val { font-size: 32px; font-weight: bold; color: #333; }
        .kpi-lbl { font-size: 13px; color: #666; text-transform: uppercase; font-weight: bold; }

        /* STATUS BADGES */
        .badge-open { background: #dc3545; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; }
        .badge-closed { background: #28a745; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; }

        /* TIMELINE FOR TRACEABILITY */
        .timeline-item { padding: 10px; border-left: 3px solid #ccc; margin-left: 10px; position: relative; }
        .timeline-item::before { content: ''; width: 12px; height: 12px; background: #fff; border: 2px solid #003366; border-radius: 50%; position: absolute; left: -7px; top: 15px; }
        .timeline-pass { border-left-color: #28a745; } .timeline-pass::before { border-color: #28a745; background: #28a745; }
        .timeline-fail { border-left-color: #dc3545; } .timeline-fail::before { border-color: #dc3545; background: #dc3545; }

        /* LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #003366; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="loader">Syncing Data...</div>

<!-- Header -->
<div class="app-header">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h1 class="app-title">PDI Master System</h1>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form')">üìù Data Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard')">üìä Performance Dash</button>
        <button class="nav-link" onclick="switchTab('closure')">üîê Lot Closure & Trace</button>
    </div>
</div>

<div class="container-fluid mt-4" style="padding-bottom:100px;">

    <!-- ======================= -->
    <!-- 1. DATA ENTRY TAB       -->
    <!-- ======================= -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex"> 
            
            <div class="card">
                <div class="card-header">General Information</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="fw-bold">Date</label>
                            <input type="date" id="date" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold">Line (Floor Auto-Detect)</label>
                            <select id="line" class="form-select" onchange="detectFloor()" required>
                                <option value="">Select Line</option>
                            </select>
                            <small class="text-primary fw-bold" id="floorDisplay">--</small>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold">Model</label>
                            <select id="model" class="form-select"><option>Model A</option><option>Model B</option><option>Model C</option></select>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold">Color</label>
                            <select id="color" class="form-select"><option>Black</option><option>White</option><option>Blue</option></select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lots Entry -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Lot Details (Multiple Lots Allowed)</span>
                    <button type="button" class="btn btn-sm btn-light fw-bold text-dark" onclick="addLotRow()">+ Add Lot</button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered lot-table mb-0">
                        <thead>
                            <tr>
                                <th width="12%">Lot ID</th>
                                <th width="10%">Qty</th>
                                <th width="12%">Status</th>
                                <th width="12%">Result</th>
                                <th>Defect Details (If Fail)</th>
                                <th width="5%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <div class="text-end">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
                <button type="submit" class="btn btn-success px-5 ms-2">Save to Sheet</button>
            </div>
        </form>

        <!-- Existing Records Table -->
        <div class="card mt-4">
            <div class="card-header">Recent Records</div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-striped table-sm text-center align-middle mb-0">
                        <thead class="table-dark" style="position: sticky; top: 0;">
                            <tr><th>Date</th><th>Line</th><th>Lot ID</th><th>Result</th><th>Defect</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="crudTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!-- 2. PERFORMANCE DASH     -->
    <!-- ======================= -->
    <div id="tab-dashboard" style="display:none;">
        <div class="card p-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-3"><label>From</label><input type="date" id="dashStart" class="form-control"></div>
                <div class="col-md-3"><label>To</label><input type="date" id="dashEnd" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="loadDashboard()">Load Data</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger" onclick="downloadPPT()"><i class="bi bi-file-ppt"></i> Download PPT</button></div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-lbl">Total Lots Offered</div><div class="kpi-val" id="kpi_lots">0</div></div></div>
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-lbl">Total Qty Offered</div><div class="kpi-val" id="kpi_qty">0</div></div></div>
            <div class="col-md-3"><div class="kpi-box" style="border-color:#28a745"><div class="kpi-lbl">LAR % (Lot Wise)</div><div class="kpi-val text-success" id="kpi_lar">0%</div></div></div>
            <div class="col-md-3"><div class="kpi-box" style="border-color:#17a2b8"><div class="kpi-lbl">Pass Rate % (Qty Wise)</div><div class="kpi-val text-info" id="kpi_pass">0%</div></div></div>
        </div>

        <!-- Charts -->
        <div class="row g-3 mb-4">
            <div class="col-md-6"><div class="card h-100"><div class="card-header">Trend: Pass Rate (Qty)</div><div class="card-body"><div id="chart_trend_qty" style="height:300px"></div></div></div></div>
            <div class="col-md-6"><div class="card h-100"><div class="card-header">Trend: LAR (Lot)</div><div class="card-body"><div id="chart_trend_lot" style="height:300px"></div></div></div></div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-6"><div class="card h-100"><div class="card-header">Floor Wise Performance</div><div class="card-body"><div id="chart_floor_pass" style="height:300px"></div></div></div></div>
            <div class="col-md-6"><div class="card h-100"><div class="card-header">Defect Pareto</div><div class="card-body"><div id="chart_pareto" style="height:300px"></div></div></div></div>
        </div>

        <!-- Action Plan -->
        <div class="card">
            <div class="card-header bg-danger text-white">Action Plan (Top 5 Defects)</div>
            <div class="card-body">
                <table class="table table-bordered table-sm">
                    <thead><tr><th>Defect Name</th><th>Qty</th><th>Root Cause & Action</th></tr></thead>
                    <tbody id="actionPlanBody"></tbody>
                </table>
                <label class="fw-bold">Overall Remarks:</label>
                <textarea id="overallRemarks" class="form-control" rows="2"></textarea>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!-- 3. LOT CLOSURE TAB      -->
    <!-- ======================= -->
    <div id="tab-closure" style="display:none;">
        
        <div class="row g-3 mb-4">
            <!-- Search Traceability -->
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header bg-dark text-white">üîç Lot Traceability Search</div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="traceInput" class="form-control" placeholder="Enter Lot ID (e.g. A01)...">
                            <button class="btn btn-primary" onclick="traceLot()">Trace History</button>
                        </div>
                        <div id="traceResult">
                            <p class="text-muted text-center">Enter a Lot ID to see its full life-cycle (Fail -> Rework -> Pass).</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Closure KPI -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">üèÜ Closure Status</div>
                    <div class="card-body text-center">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="kpi-lbl">Unique Lots</div>
                                <div class="kpi-val" id="cl_total">0</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="kpi-lbl">Closed (Pass)</div>
                                <div class="kpi-val text-success" id="cl_closed">0</div>
                            </div>
                            <div class="col-12">
                                <hr>
                                <div class="kpi-lbl">Open (Pending/Fail)</div>
                                <div class="kpi-val text-danger" id="cl_open">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Lots List (Floor Wise) -->
        <div class="card">
            <div class="card-header bg-warning text-dark">‚ö†Ô∏è Open / Pending Lots (Action Required)</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 border-end">
                        <h5 class="text-primary text-center">Floor 1</h5>
                        <ul id="open_f1" class="list-group list-group-flush small" style="max-height:300px; overflow-y:auto;"></ul>
                    </div>
                    <div class="col-md-4 border-end">
                        <h5 class="text-primary text-center">Floor 2</h5>
                        <ul id="open_f2" class="list-group list-group-flush small" style="max-height:300px; overflow-y:auto;"></ul>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-primary text-center">Basement</h5>
                        <ul id="open_fb" class="list-group list-group-flush small" style="max-height:300px; overflow-y:auto;"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Record Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="previewContent"></div></div></div>
</div>

<script>
// ===========================================
// CONFIGURATION
// ===========================================
// ‚ö†Ô∏è REPLACE THIS URL WITH YOUR DEPLOYED GOOGLE SCRIPT URL
const API_URL = "https://script.google.com/macros/s/AKfycbyKy7X0OWvjeMSVpM36HGH3fVE_XQQ8alDUbhh1msX9gjVPHBtGvdvgkuOefSGfSRX7/exec"; 

let sheetData = []; 
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = function() {
    let ls = document.getElementById('line');
    for(let i=1;i<=21;i++) ls.add(new Option(i,i));
    
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('dashStart').value = today;
    document.getElementById('dashEnd').value = today;

    addLotRow();
    loadDashboard(); // Load data initially
};

function switchTab(tab){
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    event.target.classList.add('active');
    
    if(tab === 'closure') processClosureData(); // Refresh closure data when tab clicked
}

function detectFloor(){
    let l = parseInt(document.getElementById('line').value||0);
    let f = (l>=1 && l<=8) ? "Floor 1" : (l>=9 && l<=16) ? "Floor 2" : (l>=17) ? "Basement" : "--";
    document.getElementById('floorDisplay').innerText = f;
    return f;
}

// ===========================================
// 1. DATA ENTRY LOGIC
// ===========================================
function addLotRow(data = null){
    const tbody = document.getElementById('lotContainer');
    const tr = document.createElement('tr');
    tr.className = 'lot-row';
    tr.innerHTML = `
        <td><input type="text" class="form-control form-control-sm l-id" placeholder="Lot ID" required style="font-weight:bold; text-transform:uppercase;"></td>
        <td><input type="number" class="form-control form-control-sm l-qty" placeholder="Qty" required></td>
        <td><select class="form-select form-select-sm l-status"><option>Fresh</option><option>Rework</option><option>Warranty</option><option>Market Rework</option></select></td>
        <td>
            <select class="form-select form-select-sm l-result fw-bold" onchange="toggleDefect(this)">
                <option value="Pass" style="color:green">Pass</option>
                <option value="Fail" style="color:red">Fail</option>
                <option value="Hold" style="color:orange">Hold</option>
            </select>
        </td>
        <td>
            <div class="defect-details" style="display:none;">
                <div class="input-group input-group-sm mb-1">
                    <input type="text" class="form-control d-name" placeholder="Defect Name">
                    <input type="number" class="form-control d-qty" placeholder="Qty">
                </div>
                <div class="input-group input-group-sm mb-1">
                    <select class="form-select d-stage"><option>LQC</option><option>FT</option><option>Packing</option></select>
                    <select class="form-select d-belong"><option>Earbuds</option><option>Case</option></select>
                </div>
                <input type="text" class="form-control form-control-sm d-ana" placeholder="Analysis">
            </div>
            <span class="text-success small fw-bold pass-msg">No Defect</span>
        </td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">X</button></td>
    `;
    tbody.appendChild(tr);

    if(data){
        tr.querySelector('.l-id').value = data[5];
        tr.querySelector('.l-qty').value = data[6];
        tr.querySelector('.l-status').value = data[7];
        tr.querySelector('.l-result').value = data[8];
        toggleDefect(tr.querySelector('.l-result'));
        if(data[8]==='Fail'){
            tr.querySelector('.d-name').value = data[9];
            tr.querySelector('.d-qty').value = data[10];
            tr.querySelector('.d-stage').value = data[11];
            tr.querySelector('.d-ana').value = data[12];
        }
    }
}

function toggleDefect(sel){
    let cell = sel.closest('td').nextElementSibling;
    if(sel.value === 'Fail'){
        cell.querySelector('.defect-details').style.display='block';
        cell.querySelector('.pass-msg').style.display='none';
    } else {
        cell.querySelector('.defect-details').style.display='none';
        cell.querySelector('.pass-msg').style.display='block';
    }
}

document.getElementById('pdiForm').addEventListener('submit', async function(e){
    e.preventDefault();
    if(!API_URL.includes("script.google.com")){ alert("API URL not configured!"); return; }
    
    document.getElementById('loader').style.display='flex';
    
    // Header
    let date = document.getElementById('date').value;
    let line = document.getElementById('line').value;
    let floor = document.getElementById('floorDisplay').innerText;
    let model = document.getElementById('model').value;
    let color = document.getElementById('color').value;

    let rowsToSave = [];
    document.querySelectorAll('.lot-row').forEach(tr => {
        let res = tr.querySelector('.l-result').value;
        let dName = res==='Fail' ? tr.querySelector('.d-name').value : "";
        let dQty = res==='Fail' ? tr.querySelector('.d-qty').value : 0;
        let dStage = res==='Fail' ? tr.querySelector('.d-stage').value : "";
        let dAna = res==='Fail' ? tr.querySelector('.d-ana').value : "";
        let lotId = tr.querySelector('.l-id').value.toUpperCase();

        // [Date, Line, Floor, Model, Color, LotID, Qty, Status, Result, DefectName, DefectQty, Stage, Analysis]
        rowsToSave.push([date, line, floor, model, color, lotId, tr.querySelector('.l-qty').value, tr.querySelector('.l-status').value, res, dName, dQty, dStage, dAna]);
    });

    let editIdx = document.getElementById('editRowIndex').value;
    let payload = { action: "save", data: rowsToSave };
    if(editIdx) payload = { action: "edit", rowIndex: editIdx, data: rowsToSave[0] };

    try{
        await fetch(API_URL, {method:'POST', body:JSON.stringify(payload)});
        alert("Data Saved!");
        resetForm();
        loadDashboard();
    } catch(err){ console.error(err); alert("Save Failed!"); }
    finally{ document.getElementById('loader').style.display='none'; }
});

function resetForm(){
    document.getElementById('pdiForm').reset();
    document.getElementById('lotContainer').innerHTML = "";
    document.getElementById('editRowIndex').value = "";
    addLotRow();
}

// ===========================================
// 2. DASHBOARD & DATA FETCH
// ===========================================
async function loadDashboard(){
    if(!API_URL.includes("script.google.com")) return;
    document.getElementById('loader').style.display='flex';
    
    try {
        let res = await fetch(API_URL);
        let json = await res.json();
        sheetData = json.data; 
        if(sheetData.length && sheetData[0][0] === "Date") sheetData.shift(); // Remove header

        processDashboardData();
        renderCrudTable();
    } catch(e) { console.error(e); }
    finally { document.getElementById('loader').style.display='none'; }
}

function processDashboardData(){
    let start = document.getElementById('dashStart').value;
    let end = document.getElementById('dashEnd').value;
    let data = sheetData.filter(r => r[0] >= start && r[0] <= end);

    let totalLots=0, passLots=0, totalQty=0, passQty=0;
    let dateStats = {}, floorStats = { "Floor 1": {l:0, pl:0, q:0, pq:0}, "Floor 2": {l:0, pl:0, q:0, pq:0}, "Basement": {l:0, pl:0, q:0, pq:0} };
    let defectCounts = {};

    data.forEach(r => {
        let date = r[0].split('T')[0];
        let floor = r[2] || "Floor 1";
        let qty = parseInt(r[6]||0);
        let res = r[8];
        let dQty = parseInt(r[10]||0);

        totalLots++; totalQty += qty;
        if(!dateStats[date]) dateStats[date] = {l:0, pl:0, q:0, pq:0};
        
        dateStats[date].l++; floorStats[floor].l++;
        dateStats[date].q += qty; floorStats[floor].q += qty;

        if(res === 'Pass'){
            passLots++; passQty += qty;
            dateStats[date].pl++; floorStats[floor].pl++;
            dateStats[date].pq += qty; floorStats[floor].pq += qty;
        } else {
            let okQty = qty - dQty;
            passQty += okQty;
            dateStats[date].pq += okQty; floorStats[floor].pq += okQty;
            if(r[9]) defectCounts[r[9]] = (defectCounts[r[9]]||0) + dQty;
        }
    });

    document.getElementById('kpi_lots').innerText = totalLots;
    document.getElementById('kpi_qty').innerText = totalQty;
    document.getElementById('kpi_lar').innerText = totalLots ? (passLots/totalLots*100).toFixed(2)+"%" : "0%";
    document.getElementById('kpi_pass').innerText = totalQty ? (passQty/totalQty*100).toFixed(2)+"%" : "0%";

    // Charts
    let dateArr = Object.keys(dateStats).sort();
    let trendQty = [['Date', 'Pass Rate %']], trendLot = [['Date', 'LAR %']];
    dateArr.forEach(d => {
        let s = dateStats[d];
        trendQty.push([d, s.q?(s.pq/s.q*100):0]);
        trendLot.push([d, s.l?(s.pl/s.l*100):0]);
    });
    drawLineChart('chart_trend_qty', trendQty, '#003366');
    drawLineChart('chart_trend_lot', trendLot, '#28a745');

    let floors = ["Floor 1", "Floor 2", "Basement"];
    let floorPass = [['Floor', 'Pass %']], floorLar = [['Floor', 'LAR %']];
    floors.forEach(f => {
        let s = floorStats[f];
        floorPass.push([f, s.q?(s.pq/s.q*100):0]);
        floorLar.push([f, s.l?(s.pl/s.l*100):0]);
    });
    drawBarChart('chart_floor_pass', floorPass, '#17a2b8');
    drawBarChart('chart_floor_lar', floorLar, '#ffc107');

    let defects = Object.keys(defectCounts).map(k=>({n:k, q:defectCounts[k]})).sort((a,b)=>b.q-a.q).slice(0,5);
    let pareto = [['Defect', 'Qty']];
    let actionHtml = "";
    if(defects.length===0) pareto.push(['No Data',0]);
    defects.forEach(d => {
        pareto.push([d.n, d.q]);
        actionHtml += `<tr><td>${d.n}</td><td>${d.q}</td><td><input class="form-control form-control-sm" placeholder="Plan..."></td></tr>`;
    });
    drawBarChart('chart_pareto', pareto, '#dc3545');
    document.getElementById('actionPlanBody').innerHTML = actionHtml;
}

function drawLineChart(id, data, color) {
    if(data.length<2) data.push(['',0]);
    new google.visualization.LineChart(document.getElementById(id)).draw(google.visualization.arrayToDataTable(data), {legend:'none', colors:[color], vAxis:{minValue:0, maxValue:100}, pointSize:5});
}
function drawBarChart(id, data, color) {
    new google.visualization.ColumnChart(document.getElementById(id)).draw(google.visualization.arrayToDataTable(data), {legend:'none', colors:[color], vAxis:{minValue:0}});
}

// ===========================================
// 3. LOT CLOSURE & TRACEABILITY LOGIC
// ===========================================
function processClosureData() {
    let lotsMap = {}; // { LotID: { lastRes: 'Pass/Fail', floor: 'Floor 1', history: [] } }
    
    // Group all data by Lot ID
    sheetData.forEach(r => {
        let lotId = r[5]; // Lot ID Column
        let res = r[8];   // Result
        let floor = r[2]; // Floor
        
        if(!lotsMap[lotId]) lotsMap[lotId] = { history: [], floor: floor };
        
        lotsMap[lotId].history.push(r);
        // Since we process from top to bottom, the last status overwrites previous
        lotsMap[lotId].lastRes = res; 
        lotsMap[lotId].floor = floor; // Update location if moved
    });

    let openLists = { "Floor 1": [], "Floor 2": [], "Basement": [] };
    let totalUniq = 0, closed = 0, open = 0;

    Object.keys(lotsMap).forEach(id => {
        totalUniq++;
        let lot = lotsMap[id];
        
        // Check Closure Rule: If last status is Pass -> Closed. Else -> Open.
        if(lot.lastRes === 'Pass') {
            closed++;
        } else {
            open++;
            // Add to pending list
            let txt = `<b>${id}</b> (${lot.history[lot.history.length-1][3]})`; // ID + Model
            if(openLists[lot.floor]) openLists[lot.floor].push(txt);
        }
    });

    // Update UI
    document.getElementById('cl_total').innerText = totalUniq;
    document.getElementById('cl_closed').innerText = closed;
    document.getElementById('cl_open').innerText = open;

    const fillList = (id, arr) => document.getElementById(id).innerHTML = arr.length ? arr.map(i=>`<li class="list-group-item list-group-item-warning">${i}</li>`).join('') : '<li class="list-group-item text-muted">No Pending Lots</li>';
    fillList('open_f1', openLists["Floor 1"]);
    fillList('open_f2', openLists["Floor 2"]);
    fillList('open_fb', openLists["Basement"]);
}

function traceLot(){
    let id = document.getElementById('traceInput').value.trim().toUpperCase();
    if(!id) return;
    
    // Filter Sheet Data for this Lot ID
    let history = sheetData.filter(r => r[5] === id);
    let div = document.getElementById('traceResult');
    
    if(history.length === 0){
        div.innerHTML = `<div class="alert alert-warning">Lot ID <b>${id}</b> Not Found in records!</div>`;
        return;
    }
    
    // Build Timeline
    let html = `<div class="mt-3">`;
    history.forEach(r => {
        let isPass = r[8] === 'Pass';
        let cls = isPass ? 'timeline-pass' : 'timeline-fail';
        html += `
            <div class="timeline-item ${cls}">
                <strong>${r[0]} | Line ${r[1]} (${r[2]})</strong><br>
                Status: <span class="badge ${isPass ? 'bg-success':'bg-danger'}">${r[8]}</span> | Qty: ${r[6]}<br>
                ${!isPass ? `<span class="text-danger">Defect: ${r[9]} (${r[10]})</span><br>Analysis: ${r[12]}` : '<span class="text-success">Cleared Successfully</span>'}
            </div>
        `;
    });
    html += `</div>`;
    
    // Determine Current Status
    let last = history[history.length-1];
    let finalBadge = last[8]==='Pass' ? '<span class="badge-closed">LOT CLOSED</span>' : '<span class="badge-open">LOT OPEN / PENDING</span>';
    
    div.innerHTML = `<h5>Status: ${finalBadge}</h5>` + html;
}

// ===========================================
// CRUD & PPT
// ===========================================
function renderCrudTable(){
    const tb = document.getElementById('crudTable');
    tb.innerHTML = "";
    sheetData.slice(-50).reverse().forEach(r => {
        let idx = sheetData.indexOf(r);
        tb.innerHTML += `<tr>
            <td>${r[0]}</td><td>L${r[1]}</td><td><b>${r[5]}</b></td>
            <td class="${r[8]==='Pass'?'text-success':'text-danger'} fw-bold">${r[8]}</td>
            <td>${r[9]||'-'}</td>
            <td>
                <button class="btn btn-sm btn-light border" onclick="previewRow(${idx})">üëÅÔ∏è</button>
                <button class="btn btn-sm btn-light border" onclick="editRow(${idx})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="delRow(${idx})">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
}

function previewRow(idx){
    let r = sheetData[idx];
    document.getElementById('previewContent').innerHTML = `
        <ul class="list-group">
            <li class="list-group-item"><b>Date:</b> ${r[0]}</li>
            <li class="list-group-item"><b>Line:</b> ${r[1]} (${r[2]})</li>
            <li class="list-group-item"><b>Lot:</b> ${r[5]}</li>
            <li class="list-group-item"><b>Result:</b> ${r[8]}</li>
            <li class="list-group-item"><b>Defect:</b> ${r[9]}</li>
        </ul>`;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function editRow(idx){
    let r = sheetData[idx];
    switchTab('form');
    document.getElementById('editRowIndex').value = idx;
    document.getElementById('date').value = r[0];
    document.getElementById('line').value = r[1]; detectFloor();
    document.getElementById('model').value = r[3];
    document.getElementById('color').value = r[4];
    document.getElementById('lotContainer').innerHTML = "";
    addLotRow(r);
    window.scrollTo(0,0);
}

async function delRow(idx){
    if(confirm("Delete Record?")){
        document.getElementById('loader').style.display='flex';
        await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex:idx})});
        loadDashboard();
    }
}

function downloadPPT(){
    let pres = new PptxGenJS();
    let s1 = pres.addSlide();
    s1.addText("PDI REPORT", { x:1, y:1, fontSize:24, color:'003366', bold:true });
    
    // Stats
    let stats = [
        ["Total Lots", "Total Qty", "LAR %", "Pass Rate %"],
        [document.getElementById('kpi_lots').innerText, document.getElementById('kpi_qty').innerText, document.getElementById('kpi_lar').innerText, document.getElementById('kpi_pass').innerText]
    ];
    s1.addTable(stats, {x:1, y:2, w:8});

    // Action Plan
    let s2 = pres.addSlide();
    s2.addText("ACTION PLAN", { x:0.5, y:0.5, fontSize:18, bold:true, color:'DC3545' });
    let plan = [["Defect", "Qty", "Action"]];
    document.querySelectorAll('#actionPlanBody tr').forEach(tr => {
        let tds = tr.querySelectorAll('td');
        if(tds.length) plan.push([tds[0].innerText, tds[1].innerText, tds[2].querySelector('input').value]);
    });
    s2.addTable(plan, {x:0.5, y:1.5, w:9});
    
    pres.writeFile({ fileName: "PDI_Report.pptx" });
}
</script>

</body>
</html>
