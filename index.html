<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Performance System</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Header */
        .app-header { background: white; border-bottom: 4px solid #003366; padding: 10px 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .logo { height: 50px; }
        .app-title { color: #003366; font-weight: bold; margin: 0; font-size: 24px; text-transform: uppercase; }

        /* Navigation */
        .nav-pills .nav-link.active { background-color: #003366; }
        .nav-pills .nav-link { color: #555; font-weight: 600; margin-right: 10px; }

        /* Cards */
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background: #003366; color: white; font-weight: bold; border-radius: 8px 8px 0 0 !important; }

        /* Lot Entry Table */
        .lot-table th { background: #f8f9fa; font-size: 13px; text-align: center; }
        .lot-table td { vertical-align: middle; padding: 5px; }
        .defect-section { background: #fff5f5; padding: 10px; border: 1px dashed red; border-radius: 4px; display: none; margin-top: 5px; }
        
        /* Dashboard */
        .kpi-box { background: white; padding: 15px; border-radius: 8px; border-left: 5px solid #003366; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .kpi-val { font-size: 24px; font-weight: bold; color: #333; }
        .kpi-lbl { font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold; }

        /* Action Plan */
        .action-table th { background: #333; color: white; }
    </style>
</head>
<body>

<!-- Header -->
<div class="app-header">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo" id="logoImg">
        <h1 class="app-title">PDI Performance Report</h1>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form')">Data Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard')">Dashboard & Analysis</button>
    </div>
</div>

<div class="container-fluid mt-4">
    
    <!-- 1. DATA ENTRY SECTION -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editIndex"> <!-- For Editing -->
            
            <!-- Master Info -->
            <div class="card">
                <div class="card-header">General Information</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Date</label>
                            <input type="date" id="date" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Line No</label>
                            <select id="line" class="form-select" onchange="detectFloor()" required>
                                <option value="">Select Line</option>
                                <!-- JS will populate 1-21 -->
                            </select>
                            <small class="text-primary fw-bold" id="floorDisplay"></small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Model</label>
                            <select id="model" class="form-select">
                                <option>Model A</option><option>Model B</option><option>Model C</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Color</label>
                            <select id="color" class="form-select">
                                <option>Black</option><option>White</option><option>Blue</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lots Section -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Lot Details (Add Multiple)</span>
                    <button type="button" class="btn btn-sm btn-light text-dark fw-bold" onclick="addLotRow()">+ Add Lot</button>
                </div>
                <div class="card-body p-2">
                    <table class="table table-bordered lot-table mb-0">
                        <thead>
                            <tr>
                                <th width="15%">Lot ID</th>
                                <th width="10%">Qty</th>
                                <th width="15%">Status</th>
                                <th width="15%">Result</th>
                                <th width="40%">Defect Info (If Fail)</th>
                                <th width="5%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer">
                            <!-- Rows added by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="text-end mb-5">
                <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">Clear</button>
                <button type="submit" class="btn btn-success px-5">Save Record</button>
            </div>
        </form>

        <!-- Data List -->
        <div class="card">
            <div class="card-header">Recent Entries</div>
            <div class="card-body">
                <table class="table table-hover table-sm text-center">
                    <thead class="table-dark">
                        <tr><th>Date</th><th>Line</th><th>Model</th><th>Lots</th><th>Total Qty</th><th>Result (Pass/Fail)</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. DASHBOARD SECTION -->
    <div id="tab-dashboard" style="display:none;">
        <!-- Filters -->
        <div class="card p-3 mb-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-3"><label>Start Date</label><input type="date" id="dashStart" class="form-control"></div>
                <div class="col-md-3"><label>End Date</label><input type="date" id="dashEnd" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="loadDashboard()">Filter Data</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger" onclick="downloadPPT()"><i class="bi bi-file-ppt"></i> Download PPT Report</button></div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-lbl">Total Lots Offered</div><div class="kpi-val" id="kpi_lots">0</div></div></div>
            <div class="col-md-3"><div class="kpi-box"><div class="kpi-lbl">Total Qty Offered</div><div class="kpi-val" id="kpi_qty">0</div></div></div>
            <div class="col-md-3"><div class="kpi-box" style="border-color:#28a745"><div class="kpi-lbl">PDI LAR % (Lot Wise)</div><div class="kpi-val text-success" id="kpi_lar">0%</div></div></div>
            <div class="col-md-3"><div class="kpi-box" style="border-color:#17a2b8"><div class="kpi-lbl">PDI Pass Rate % (Qty Wise)</div><div class="kpi-val text-info" id="kpi_pass">0%</div></div></div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card"><div class="card-body" style="height:350px;" id="chart_trend_qty"></div></div>
            </div>
            <div class="col-md-6">
                <div class="card"><div class="card-body" style="height:350px;" id="chart_trend_lot"></div></div>
            </div>
        </div>

        <!-- Floor Wise -->
        <div class="card mb-4">
            <div class="card-header">Floor Wise Performance</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6"><div style="height:300px;" id="chart_floor_lar"></div></div>
                    <div class="col-md-6"><div style="height:300px;" id="chart_floor_pass"></div></div>
                </div>
            </div>
        </div>

        <!-- Defect Analysis & Action Plan -->
        <div class="row g-3">
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">Top 5 Defects (Pareto)</div>
                    <div class="card-body" style="height:400px;" id="chart_pareto"></div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-header bg-danger text-white">Defect Analysis & Action Plan</div>
                    <div class="card-body">
                        <table class="table table-bordered action-table">
                            <thead><tr><th>Defect</th><th>Qty</th><th>Root Cause & Action Plan</th></tr></thead>
                            <tbody id="actionPlanBody">
                                <!-- Top 5 defects auto populated -->
                            </tbody>
                        </table>
                        <textarea class="form-control mt-2" id="generalAction" rows="3" placeholder="Overall Remarks / Management Comments..."></textarea>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// --- CONFIG & STATE ---
// ⚠️ PASTE YOUR GOOGLE SCRIPT URL HERE FOR SAVING
const API_URL = "https://script.google.com/macros/s/AKfycbzkn_YQtnDPW47OTPt9ZlASfj66JMmYdGjbCOvhVL3mwXvfERdtFY761KDqut88dv42FQ/exec"; 

let allData = []; // Stores local session data
google.charts.load('current', {'packages':['corechart', 'bar']});

// --- INITIALIZATION ---
window.onload = function() {
    // Populate Lines 1-21
    let lineSel = document.getElementById('line');
    for(let i=1; i<=21; i++) {
        let opt = document.createElement('option');
        opt.value = i; opt.innerText = "Line " + i;
        lineSel.appendChild(opt);
    }
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('dashStart').valueAsDate = new Date();
    document.getElementById('dashEnd').valueAsDate = new Date();
    
    addLotRow(); // Add first empty row
    loadFakeData(); // For demo, replace with API fetch
};

function switchTab(tab){
    document.getElementById('tab-form').style.display = tab==='form' ? 'block' : 'none';
    document.getElementById('tab-dashboard').style.display = tab==='dashboard' ? 'block' : 'none';
    document.querySelector('.nav-link.active').classList.remove('active');
    event.target.classList.add('active');
    if(tab === 'dashboard') loadDashboard();
}

function detectFloor(){
    let l = parseInt(document.getElementById('line').value);
    let f = "";
    if(l >= 1 && l <= 8) f = "1st Floor";
    else if(l >= 9 && l <= 16) f = "2nd Floor";
    else if(l >= 17 && l <= 21) f = "Basement";
    document.getElementById('floorDisplay').innerText = f;
    return f;
}

// --- FORM LOGIC ---
function addLotRow(data = null){
    const tbody = document.getElementById('lotContainer');
    const tr = document.createElement('tr');
    tr.className = 'lot-row';
    
    let html = `
        <td><input type="text" class="form-control form-control-sm l-id" placeholder="Lot ID"></td>
        <td><input type="number" class="form-control form-control-sm l-qty" placeholder="0"></td>
        <td>
            <select class="form-select form-select-sm l-status">
                <option>Fresh</option><option>Rework</option><option>Warranty</option><option>Market Rework</option>
            </select>
        </td>
        <td>
            <select class="form-select form-select-sm l-result" onchange="toggleDefect(this)">
                <option value="Pass">Pass</option><option value="Fail">Fail</option><option value="Hold">Hold</option>
            </select>
        </td>
        <td>
            <div class="defect-inputs" style="display:none;">
                <div class="input-group input-group-sm mb-1">
                    <input type="text" class="form-control d-name" placeholder="Defect Name">
                    <input type="number" class="form-control d-qty" placeholder="Qty">
                </div>
                <div class="input-group input-group-sm mb-1">
                    <select class="form-select d-stage"><option>LQC</option><option>FT</option><option>Packing</option></select>
                    <select class="form-select d-belong"><option>Earbuds</option><option>Case</option></select>
                </div>
                <input type="text" class="form-control form-control-sm d-analysis" placeholder="Analysis / Root Cause">
            </div>
            <span class="pass-msg text-success small fw-bold">No Defects (Passed)</span>
        </td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">X</button></td>
    `;
    tr.innerHTML = html;
    tbody.appendChild(tr);

    if(data) {
        tr.querySelector('.l-id').value = data.id;
        tr.querySelector('.l-qty').value = data.qty;
        tr.querySelector('.l-status').value = data.status;
        tr.querySelector('.l-result').value = data.result;
        toggleDefect(tr.querySelector('.l-result'));
        if(data.result === 'Fail'){
            tr.querySelector('.d-name').value = data.d_name;
            tr.querySelector('.d-qty').value = data.d_qty;
            tr.querySelector('.d-stage').value = data.d_stage;
            tr.querySelector('.d-belong').value = data.d_belong;
            tr.querySelector('.d-analysis').value = data.d_analysis;
        }
    }
}

function toggleDefect(select){
    const cell = select.closest('tr').cells[4];
    const inputs = cell.querySelector('.defect-inputs');
    const msg = cell.querySelector('.pass-msg');
    
    if(select.value === 'Fail'){
        inputs.style.display = 'block';
        msg.style.display = 'none';
    } else {
        inputs.style.display = 'none';
        msg.style.display = 'block';
    }
}

document.getElementById('pdiForm').addEventListener('submit', function(e){
    e.preventDefault();
    
    // Collect Header
    let record = {
        id: Date.now(),
        date: document.getElementById('date').value,
        line: document.getElementById('line').value,
        floor: document.getElementById('floorDisplay').innerText,
        model: document.getElementById('model').value,
        color: document.getElementById('color').value,
        lots: []
    };

    // Collect Lots
    let rows = document.querySelectorAll('.lot-row');
    rows.forEach(r => {
        let lot = {
            id: r.querySelector('.l-id').value,
            qty: parseInt(r.querySelector('.l-qty').value) || 0,
            status: r.querySelector('.l-status').value,
            result: r.querySelector('.l-result').value,
            d_name: "", d_qty: 0, d_stage: "", d_belong: "", d_analysis: ""
        };
        if(lot.result === 'Fail'){
            lot.d_name = r.querySelector('.d-name').value;
            lot.d_qty = parseInt(r.querySelector('.d-qty').value) || 0;
            lot.d_stage = r.querySelector('.d-stage').value;
            lot.d_belong = r.querySelector('.d-belong').value;
            lot.d_analysis = r.querySelector('.d-analysis').value;
        }
        record.lots.push(lot);
    });

    let editIdx = document.getElementById('editIndex').value;
    if(editIdx){
        allData[editIdx] = record;
        document.getElementById('editIndex').value = "";
    } else {
        allData.push(record);
    }
    
    alert("Saved Successfully!");
    resetForm();
    renderTable();
    // In real app, perform fetch(API_URL, ...) here
});

function resetForm(){
    document.getElementById('pdiForm').reset();
    document.getElementById('lotContainer').innerHTML = "";
    addLotRow();
}

function renderTable(){
    const tb = document.getElementById('dataTable');
    tb.innerHTML = "";
    allData.forEach((r, idx) => {
        let totalQty = r.lots.reduce((acc, l) => acc + l.qty, 0);
        let failCount = r.lots.filter(l => l.result === 'Fail').length;
        let overall = failCount > 0 ? `<span class="badge bg-danger">Fail (${failCount})</span>` : `<span class="badge bg-success">Pass</span>`;
        
        let row = `<tr>
            <td>${r.date}</td><td>Line ${r.line}</td><td>${r.model}</td>
            <td>${r.lots.length}</td><td>${totalQty}</td><td>${overall}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editRec(${idx})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="delRec(${idx})">Del</button>
            </td>
        </tr>`;
        tb.innerHTML += row;
    });
}

function editRec(idx){
    let r = allData[idx];
    document.getElementById('date').value = r.date;
    document.getElementById('line').value = r.line;
    detectFloor();
    document.getElementById('model').value = r.model;
    document.getElementById('color').value = r.color;
    document.getElementById('lotContainer').innerHTML = "";
    r.lots.forEach(l => addLotRow(l));
    document.getElementById('editIndex').value = idx;
    switchTab('form');
    window.scrollTo(0,0);
}

function delRec(idx){
    if(confirm("Delete?")) {
        allData.splice(idx, 1);
        renderTable();
    }
}

// --- FAKE DATA FOR DEMO ---
function loadFakeData(){
    // Generating some history
    for(let i=0; i<5; i++){
        allData.push({
            id: i, date: '2025-12-'+(14+i), line: (Math.floor(Math.random()*20)+1), floor: '1st Floor', 
            model: 'Model A', color: 'Black',
            lots: [
                { id: 'L00'+i, qty: 1000, status: 'Fresh', result: 'Pass', d_qty:0 },
                { id: 'L01'+i, qty: 500, status: 'Fresh', result: 'Fail', d_name: 'Sound Issue', d_qty: 20, d_stage:'FT', d_belong:'Earbuds', d_analysis:'Speaker loose' }
            ]
        });
    }
    renderTable();
}

// --- DASHBOARD LOGIC ---
function loadDashboard(){
    let start = document.getElementById('dashStart').value;
    let end = document.getElementById('dashEnd').value;
    
    // Filter
    let filtered = allData.filter(r => r.date >= start && r.date <= end);
    
    // Aggregates
    let totalLots = 0, passedLots = 0;
    let totalQty = 0, passedQty = 0; // (Total - Defect)
    let dateMap = {}; // { date: { lots:0, passLots:0, qty:0, passQty:0 } }
    let floorMap = {}; // { floor: { lots:0, passLots:0, qty:0, passQty:0 } }
    let defectMap = {}; // { name: count }

    filtered.forEach(r => {
        let d = r.date;
        let f = getFloorByLine(r.line);
        if(!dateMap[d]) dateMap[d] = {l:0, pl:0, q:0, pq:0};
        if(!floorMap[f]) floorMap[f] = {l:0, pl:0, q:0, pq:0};

        r.lots.forEach(lot => {
            totalLots++;
            dateMap[d].l++; floorMap[f].l++;
            
            let q = lot.qty;
            totalQty += q;
            dateMap[d].q += q; floorMap[f].q += q;

            if(lot.result === 'Pass'){
                passedLots++;
                dateMap[d].pl++; floorMap[f].pl++;
                passedQty += q;
                dateMap[d].pq += q; floorMap[f].pq += q;
            } else {
                // Fail
                let goodQty = q - (lot.d_qty || 0);
                passedQty += goodQty;
                dateMap[d].pq += goodQty; floorMap[f].pq += goodQty;
                
                // Defects
                if(lot.d_name) {
                    if(!defectMap[lot.d_name]) defectMap[lot.d_name] = 0;
                    defectMap[lot.d_name] += (lot.d_qty || 0);
                }
            }
        });
    });

    // KPI
    document.getElementById('kpi_lots').innerText = totalLots;
    document.getElementById('kpi_qty').innerText = totalQty;
    let lar = totalLots ? (passedLots/totalLots*100).toFixed(2) : 0;
    let pr = totalQty ? (passedQty/totalQty*100).toFixed(2) : 0;
    document.getElementById('kpi_lar').innerText = lar + "%";
    document.getElementById('kpi_pass').innerText = pr + "%";

    // 1. Trend Charts (Date Wise)
    let chartDataQty = [['Date', 'Pass Rate % (Qty)']];
    let chartDataLot = [['Date', 'LAR % (Lot)']];
    
    Object.keys(dateMap).sort().forEach(d => {
        let stats = dateMap[d];
        chartDataQty.push([d, stats.q ? (stats.pq/stats.q*100) : 0]);
        chartDataLot.push([d, stats.l ? (stats.pl/stats.l*100) : 0]);
    });
    
    drawTrend('chart_trend_qty', chartDataQty, 'Date-wise PDI Pass Rate Trend (Qty)');
    drawTrend('chart_trend_lot', chartDataLot, 'Date-wise LAR Trend (Lot)', '#28a745');

    // 2. Floor Charts
    let floorLarData = [['Floor', 'LAR %']];
    let floorPassData = [['Floor', 'Pass Rate %']];
    ['1st Floor', '2nd Floor', 'Basement'].forEach(f => {
        let s = floorMap[f] || {l:0, pl:0, q:0, pq:0};
        floorLarData.push([f, s.l ? (s.pl/s.l*100) : 0]);
        floorPassData.push([f, s.q ? (s.pq/s.q*100) : 0]);
    });
    drawBar('chart_floor_lar', floorLarData, 'Floor Wise LAR %');
    drawBar('chart_floor_pass', floorPassData, 'Floor Wise Pass Rate % (Qty)', '#17a2b8');

    // 3. Pareto & Action Plan
    let defectsArr = Object.keys(defectMap).map(k => ({name:k, qty:defectMap[k]}));
    defectsArr.sort((a,b) => b.qty - a.qty);
    let top5 = defectsArr.slice(0, 5);
    
    let paretoData = [['Defect', 'Qty']];
    let actionHtml = "";
    
    top5.forEach(d => {
        paretoData.push([d.name, d.qty]);
        actionHtml += `<tr><td>${d.name}</td><td>${d.qty}</td><td><textarea class="form-control form-control-sm" rows="1"></textarea></td></tr>`;
    });
    
    if(top5.length === 0) { paretoData.push(['No Defects', 0]); actionHtml = "<tr><td colspan='3'>No Defects found in selected period</td></tr>"; }
    
    drawBar('chart_pareto', paretoData, 'Top 5 Defects (Pareto)', '#dc3545');
    document.getElementById('actionPlanBody').innerHTML = actionHtml;
}

function getFloorByLine(l){
    l = parseInt(l);
    if(l <= 8) return "1st Floor";
    if(l <= 16) return "2nd Floor";
    return "Basement";
}

function drawTrend(id, data, title, color='#003366'){
    let dt = google.visualization.arrayToDataTable(data);
    let opt = { title: title, legend: { position: 'bottom' }, colors:[color], pointSize:5, vAxis:{minValue:0, maxValue:100} };
    new google.visualization.LineChart(document.getElementById(id)).draw(dt, opt);
}

function drawBar(id, data, title, color='#003366'){
    let dt = google.visualization.arrayToDataTable(data);
    let opt = { title: title, legend: { position: 'none' }, colors:[color], vAxis:{minValue:0} };
    new google.visualization.ColumnChart(document.getElementById(id)).draw(dt, opt);
}

// --- PPT GENERATION ---
function downloadPPT() {
    let pres = new PptxGenJS();
    let logoUrl = "https://i.postimg.cc/5y7SN4xc/logo.png";

    // Slide 1: Summary
    let slide1 = pres.addSlide();
    slide1.addImage({ path: logoUrl, x: 0.5, y: 0.2, w: 1.5, h: 0.5 });
    slide1.addText("PDI PERFORMANCE REPORT", { x: 3, y: 0.4, fontSize: 24, bold: true, color: "003366" });
    slide1.addText(`Period: ${document.getElementById('dashStart').value} to ${document.getElementById('dashEnd').value}`, { x: 3, y: 0.8, fontSize: 12 });

    // Summary Table
    let lar = document.getElementById('kpi_lar').innerText;
    let pr = document.getElementById('kpi_pass').innerText;
    let dataTable = [
        [{ text: "Total Lots", options: { fill: "003366", color: "ffffff", bold: true } }, { text: "Total Qty", options: { fill: "003366", color: "ffffff", bold: true } }, { text: "LAR %", options: { fill: "003366", color: "ffffff", bold: true } }, { text: "Pass Rate %", options: { fill: "003366", color: "ffffff", bold: true } }],
        [document.getElementById('kpi_lots').innerText, document.getElementById('kpi_qty').innerText, lar, pr]
    ];
    slide1.addTable(dataTable, { x: 0.5, y: 1.5, w: 9, align: "center" });

    // Slide 2: Charts (Capturing Data, not images as HTML canvas capture is complex in pure JS without plugins)
    // We will recreate basic text representation or placeholder for charts. 
    // *Ideally, use html2canvas to convert divs to images and addImage to PPT*
    // Here, I will add a text summary for the charts as placeholders are safer in pure code.
    let slide2 = pres.addSlide();
    slide2.addText("PERFORMANCE TRENDS", { x: 0.5, y: 0.5, fontSize: 18, bold: true, color: "003366" });
    slide2.addText("Please refer to the Dashboard for interactive charts.", {x:0.5, y:1.5});
    slide2.addText("Floor Wise Summary:", {x:0.5, y:2.5, bold:true});
    // Add logic to dump floor map data here if needed.

    // Slide 3: Action Plan
    let slide3 = pres.addSlide();
    slide3.addText("DEFECT ANALYSIS & ACTION PLAN", { x: 0.5, y: 0.5, fontSize: 18, bold: true, color: "DC3545" });
    
    // Scrape Action Plan Table
    let actionRows = [[{ text: "Defect", bold:true}, {text:"Qty", bold:true}, {text:"Root Cause / Action", bold:true}]];
    document.querySelectorAll('#actionPlanBody tr').forEach(tr => {
        let tds = tr.querySelectorAll('td');
        if(tds.length >= 3){
            let txt = tds[2].querySelector('textarea') ? tds[2].querySelector('textarea').value : "";
            actionRows.push([tds[0].innerText, tds[1].innerText, txt]);
        }
    });
    slide3.addTable(actionRows, { x: 0.5, y: 1.5, w: 9, colW:[3, 1.5, 4.5], border:{color:"999999"} });
    
    let remarks = document.getElementById('generalAction').value;
    if(remarks) slide3.addText(`Remarks: ${remarks}`, { x: 0.5, y: 5.0, fontSize:12 });

    pres.writeFile({ fileName: "PDI_Report.pptx" });
}

</script>

</body>
</html>
