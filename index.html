<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System v4.0</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #002244; --accent: #007bff; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 20px; }
        .form-control, .form-select, .btn { font-size: 18px !important; }
        .app-header { background: var(--primary); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo { height: 40px; }
        .nav-pills .nav-link { color: #cbd5e0; font-weight: 500; font-size: 18px; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; }
        .status-pass { background: #e6fffa; color: #234e52; padding: 5px 10px; border-radius: 6px; font-weight: bold; }
        .status-fail { background: #fff5f5; color: #822727; padding: 5px 10px; border-radius: 6px; font-weight: bold; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .summary-card { background: #f8f9fa; border-left: 5px solid var(--accent); padding: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-2 fw-bold">Processing...</div>
</div>

<!-- Header -->
<div class="app-header no-print">
    <div class="d-flex align-items-center gap-3">
        <h5 class="m-0 fw-bold">PDI MASTER SYSTEM v4.0</h5>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)">Data Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard', this)">Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure', this)">Closure</button>
    </div>
</div>

<div class="container-fluid mt-4">

    <!-- DATA ENTRY TAB -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex">
            <div class="card p-4 mb-4">
                <div class="row g-3 align-items-center">
                    <div class="col-md-3">
                        <label class="fw-bold">Entry Date</label>
                        <input type="date" id="entryDate" class="form-control" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-outline-primary fw-bold" onclick="addLotRow()">+ ADD ROW</button>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="table-light">
                            <tr class="text-center">
                                <th width="100">Line</th>
                                <th width="200">Model</th>
                                <th width="150">Colour</th>
                                <th width="150">Lot ID</th>
                                <th width="100">Qty</th>
                                <th width="120">Status</th>
                                <th width="120">Result</th>
                                <th>Defect / Remarks</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <div class="text-end mb-5">
                <button type="button" class="btn btn-light border" onclick="resetForm()">Cancel</button>
                <button type="submit" id="saveBtn" class="btn btn-success px-5 fw-bold">SAVE TO SHEET</button>
            </div>
        </form>

        <!-- RECENT DATA SECTION -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span class="fw-bold">Recent Data Records</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control" onchange="renderRecentTable()">
                    <button class="btn btn-info text-white fw-bold" onclick="showDailyPreview()">Show Day Preview</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="crudTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DASHBOARD & CLOSURE TABS (Keep same as your original) -->
    <div id="tab-dashboard" style="display:none;">... (Dashboard Content) ...</div>
    <div id="tab-closure" style="display:none;">... (Closure Content) ...</div>
</div>

<!-- PREVIEW MODAL (Day Summary) -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Daily Performance Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="summaryBody">
                <!-- Summary content will load here -->
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "YOUR_GOOGLE_SCRIPT_API_URL"; // Apna URL yaha dale

const MODELS = ["Unity ANC","Ace","111v2","131 Elite Anc","131 Gen 2","141 Anc","161 Anc","161 N","181 Pro","191 Anc","192","212","280 Anc","300","71","800","91","Ace Gen 2","Hype","Kick","Nirvana Crystal","Nirvana Iris","Nirvana X","Plus 311","Prime 412","Primo","Pulse","Supreme","Ultra Pro","100","121 Pro","131","141","161","161 Pro-Buds","181","190","191 G","207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","HMD P50","HMD S60","HMD X50","IMT 100","IMT121","IMT131","IMT161","Joy","Max","Nirvana","Nirvana Ion","R 195 Pro","Ultra Plus","Zing"];
const COLOURS = ["Black","Blue","Bold Blue","Crimson Cream","Graphite Grey","Ivory White","Krypton Blue","Lavender Rush","Moon White","Pine Green","Space Grey","Sterling Silver","White","Zinc White","Active Black","Active Teal","Aqua Blue","Ash Grey","Assassin Black","Azure Blue","Berry Blue","Carbon Black","Charcoal Black","Cherry Blossom","Cool Grey","Cosmic Onyx","Cream White","Crimsom Red","Crystal Black","Cyan cider","Deep Blue","Electric Blue","Emerald Green","Frost White","Galactic Purple","Gunmetal Black","Ice Blue","Ivory","Jet Black","Lunar White","Maroon Lush","Martian Green","Metallic Grey","Midnight Black","Midnight Blue","Mint Blue","Mist Grey","Mystic Blue","Noir Black","Ocean Blue","Olive Green","Opal Black","Orange","Peach Blush","Pearl White","Pellucid Blue","Purple","Quantum Black","Red","Rose Quartz","Saga Green","Sandstone","Shadow Black","Silver","Slate Grey","Sleek Black","Sonic Silver","Spirit White","Sporty Blue","Starry Blue","Sunset Blush","Teal","Thunder Blue","Velvet Rouge","Yellow Pop"];

let sheetData = [];

window.onload = function() {
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    addLotRow();
    loadAllData();
};

function switchTab(tab, btn) {
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
}

// Data Loading
async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0] && sheetData[0][0] === "Date") sheetData.shift();
        renderRecentTable();
    } catch(e) { console.error(e); }
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const selectedDate = document.getElementById('recentFilter').value;
    tb.innerHTML = "";
    
    let filtered = sheetData.filter(r => {
        let rd = new Date(r[0]).toISOString().split('T')[0];
        return rd === selectedDate;
    });

    if(filtered.length === 0) {
        tb.innerHTML = "<tr><td colspan='7'>No records found for this date.</td></tr>";
        return;
    }

    filtered.reverse().forEach(r => {
        let originalIdx = sheetData.indexOf(r);
        tb.innerHTML += `<tr>
            <td>${new Date(r[0]).toLocaleDateString()}</td>
            <td>L${r[1]}</td><td>${r[3]}</td><td><b>${r[5]}</b></td><td>${r[6]}</td>
            <td><span class="${r[8]==='Pass'?'status-pass':'status-fail'}">${r[8]}</span></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editRec(${originalIdx})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteRec(${originalIdx})">Del</button>
            </td>
        </tr>`;
    });
}

// Summary Logic
function showDailyPreview() {
    const selectedDate = document.getElementById('recentFilter').value;
    let filtered = sheetData.filter(r => new Date(r[0]).toISOString().split('T')[0] === selectedDate);
    
    if(!filtered.length) return alert("No data to preview!");

    let stats = { totalQty: 0, passQty: 0, failQty: 0, totalLots: filtered.length, passLots: 0, failLots: 0 };
    let floors = { "Floor 1": {t:0, p:0}, "Floor 2": {t:0, p:0}, "Basement": {t:0, p:0} };
    let rejects = [];

    filtered.forEach(r => {
        let q = parseInt(r[6]||0);
        let fl = r[2];
        stats.totalQty += q;
        if(floors[fl]) floors[fl].t += q;

        if(r[8] === 'Pass') {
            stats.passLots++;
            stats.passQty += q;
            if(floors[fl]) floors[fl].p += q;
        } else {
            stats.failLots++;
            stats.failQty += q;
            rejects.push(r);
        }
    });

    let passRate = ((stats.failQty / stats.totalQty) * 100).toFixed(2); // As per your requirement

    let html = `
        <div class="row text-center mb-4">
            <div class="col-md-3"><div class="summary-card"><h6>Total Lots</h6><h3>${stats.totalLots}</h3></div></div>
            <div class="col-md-3"><div class="summary-card text-success"><h6>Pass Lots</h6><h3>${stats.passLots}</h3></div></div>
            <div class="col-md-3"><div class="summary-card text-danger"><h6>Reject Lots</h6><h3>${stats.failLots}</h3></div></div>
            <div class="col-md-3"><div class="summary-card text-primary"><h6>Rejection Rate %</h6><h3>${passRate}%</h3></div></div>
        </div>
        
        <h5 class="fw-bold border-bottom pb-2">Floor-wise Performance</h5>
        <table class="table table-sm table-bordered mb-4">
            <thead class="table-secondary"><tr><th>Floor</th><th>Total Qty</th><th>Pass Qty</th><th>Pass %</th></tr></thead>
            <tbody>
                ${Object.keys(floors).map(f => `
                    <tr>
                        <td>${f}</td><td>${floors[f].t}</td><td>${floors[f].p}</td>
                        <td>${floors[f].t ? ((floors[f].p/floors[f].t)*100).toFixed(1) : 0}%</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>

        <h5 class="fw-bold text-danger border-bottom pb-2">Rejected Lot Details</h5>
        <table class="table table-striped table-hover">
            <thead class="table-danger">
                <tr><th>Line</th><th>Model</th><th>Colour</th><th>Qty</th><th>Status</th><th>Defect</th></tr>
            </thead>
            <tbody>
                ${rejects.map(r => `
                    <tr><td>L${r[1]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[9]}</td></tr>
                `).join('')}
                ${rejects.length === 0 ? '<tr><td colspan="6">No rejections today!</td></tr>' : ''}
            </tbody>
        </table>
    `;
    
    document.getElementById('summaryBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

// CRUD Operations
async function deleteRec(idx) {
    if(!confirm("Are you sure you want to delete this record?")) return;
    document.getElementById('loader').style.display='flex';
    await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex: idx + 2})}); // +2 for header and 0-index
    loadAllData();
}

function editRec(idx) {
    const r = sheetData[idx];
    document.getElementById('editRowIndex').value = idx + 2;
    document.getElementById('entryDate').value = new Date(r[0]).toISOString().split('T')[0];
    document.getElementById('lotContainer').innerHTML = "";
    addLotRow(r);
    document.getElementById('saveBtn').innerText = "UPDATE RECORD";
    window.scrollTo(0,0);
}

// Form Functions
function addLotRow(data = null) {
    const tr = document.createElement('tr');
    tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">Line ${i}</option>`;
    
    tr.innerHTML = `
        <td><select class="form-select i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control i-id" placeholder="LOT ID" required></td>
        <td><input type="number" class="form-control i-qty" required></td>
        <td><select class="form-select i-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select i-res fw-bold" onchange="toggleRem(this)"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control i-rem" placeholder="Defect details..." disabled></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove()">âœ–</button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);

    if(data) {
        tr.querySelector('.i-line').value = data[1];
        tr.querySelector('.i-model').value = data[3];
        tr.querySelector('.i-color').value = data[4];
        tr.querySelector('.i-id').value = data[5];
        tr.querySelector('.i-qty').value = data[6];
        tr.querySelector('.i-res').value = data[8];
        if(data[8]==='Fail'){ tr.querySelector('.i-rem').disabled=false; tr.querySelector('.i-rem').value=data[9]; }
    }
}

function toggleRem(sel) { sel.closest('tr').querySelector('.i-rem').disabled = (sel.value === 'Pass'); }

function resetForm() {
    document.getElementById('pdiForm').reset();
    document.getElementById('lotContainer').innerHTML = "";
    document.getElementById('saveBtn').innerText = "SAVE TO SHEET";
    document.getElementById('editRowIndex').value = "";
    addLotRow();
}

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    document.getElementById('loader').style.display='flex';
    const date = document.getElementById('entryDate').value;
    const editIdx = document.getElementById('editRowIndex').value;
    let rows = [];
    document.querySelectorAll('.input-row').forEach(tr => {
        let l = tr.querySelector('.i-line').value;
        rows.push([date, l, (l<=8?"Floor 1":(l<=16?"Floor 2":"Basement")), tr.querySelector('.i-model').value, tr.querySelector('.i-color').value, tr.querySelector('.i-id').value.toUpperCase(), tr.querySelector('.i-qty').value, tr.querySelector('.i-status').value, tr.querySelector('.i-res').value, tr.querySelector('.i-rem').value||""]);
    });
    
    let p = editIdx ? {action:'edit', rowIndex:editIdx, data:rows[0]} : {action:'save', data:rows};
    await fetch(API_URL, {method:'POST', body:JSON.stringify(p)});
    resetForm();
    loadAllData();
};
</script>
</body>
</html>
