<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System v7.0 (Final Edit Fix)</title><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System v7.5 (Edit Update Fix)</title>
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #002244; --accent: #007bff; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 24px; }
        .app-header { background: var(--primary); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo { height: 50px; }
        .nav-pills .nav-link { color: #cbd5e0; font-weight: 500; padding: 12px 25px; font-size: 22px; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .status-pass { background: #e6fffa; color: #234e52; padding: 5px 12px; border-radius: 6px; font-weight: bold; }
        .status-fail { background: #fff5f5; color: #822727; padding: 5px 12px; border-radius: 6px; font-weight: bold; }
        .preview-card { border-radius: 12px; color: white; padding: 20px; text-align: center; }
        .c-total { background: #002244; } .c-pass { background: #28a745; } .c-reject { background: #dc3545; } .c-rate { background: #17a2b8; }
        .edit-mode-bg { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
    <div class="mt-3 fw-bold fs-3">Processing...</div>
</div>

<div class="app-header">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h5 class="m-0 fw-bold">PDI MASTER SYSTEM</h5>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)">Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard', this)">Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure', this)">Closure</button>
    </div>
</div>

<div class="container-fluid mt-4">
    <div id="tab-form">
        <form id="pdiForm">
            <!-- Hidden Input for Edit -->
            <input type="hidden" id="editRowIndex" value="">
            
            <div class="card p-4" id="mainEntryCard">
                <div class="row g-4 align-items-center">
                    <div class="col-md-3">
                        <label class="fw-bold">Report Date</label>
                        <input type="date" id="entryDate" class="form-control" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-outline-primary btn-lg fw-bold" id="addRowBtn" onclick="addLotRow()">+ ADD ROW</button>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0" style="min-width: 1400px;">
                        <thead class="table-light text-center">
                            <tr><th>Line</th><th>Model</th><th>Colour</th><th>Lot ID</th><th>Qty</th><th>Status</th><th>Result</th><th>Defect / Remarks</th><th></th></tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-end mt-4 mb-5">
                <button type="button" class="btn btn-lg btn-light border" onclick="resetForm()">Cancel</button>
                <button type="submit" id="saveBtn" class="btn btn-lg btn-success px-5 fw-bold">SAVE TO SHEET</button>
            </div>
        </form>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Recent Records (Date-Wise Filter)</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control w-auto" onchange="renderRecentTable()">
                    <button class="btn btn-primary fw-bold" onclick="showDaySummary()">View Preview</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle">
                    <thead class="table-dark">
                        <tr><th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Action</th></tr>
                    </thead>
                    <tbody id="crudTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dashboard & Closure Tabs (Original preserved) -->
    <div id="tab-dashboard" style="display:none;">... (Original Code) ...</div>
    <div id="tab-closure" style="display:none;">... (Original Code) ...</div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header border-0"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 50px;"><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body pt-0" id="summaryBody"></div>
        </div>
    </div>
</div>

<script>
const API_URL = "APNA_NEW_DEPLOY_URL_YAHA_DALEIN";

const MODELS = ["Unity ANC","Ace","111v2","131 Elite Anc","131 Gen 2","141 Anc","161 Anc","161 N","181 Pro","191 Anc","192","212","280 Anc","300","71","800","91","Ace Gen 2","Hype","Kick","Nirvana Crystal","Nirvana Iris","Nirvana X","Plus 311","Prime 412","Primo","Pulse","Supreme","Ultra Pro","100","121 Pro","131","141","161","161 Pro-Buds","181","190","191 G","207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","HMD P50","HMD S60","HMD X50","IMT 100","IMT121","IMT131","IMT161","Joy","Max","Nirvana","Nirvana Ion","R 195 Pro","Ultra Plus","Zing"];
const COLOURS = ["Black","Blue","Bold Blue","Crimson Cream","Graphite Grey","Ivory White","Krypton Blue","Lavender Rush","Moon White","Pine Green","Space Grey","Sterling Silver","White","Zinc White","Active Black","Active Teal","Aqua Blue","Ash Grey","Assassin Black","Azure Blue","Berry Blue","Carbon Black","Charcoal Black","Cherry Blossom","Cool Grey","Cosmic Onyx","Cream White","Crimsom Red","Crystal Black","Cyan cider","Deep Blue","Electric Blue","Emerald Green","Frost White","Galactic Purple","Gunmetal Black","Ice Blue","Ivory","Jet Black","Lunar White","Maroon Lush","Martian Green","Metallic Grey","Midnight Black","Midnight Blue","Mint Blue","Mist Grey","Mystic Blue","Noir Black","Ocean Blue","Olive Green","Opal Black","Orange","Peach Blush","Pearl White","Pellucid Blue","Purple","Quantum Black","Red","Rose Quartz","Saga Green","Sandstone","Shadow Black","Silver","Slate Grey","Sleek Black","Sonic Silver","Spirit White","Sporty Blue","Starry Blue","Sunset Blush","Teal","Thunder Blue","Velvet Rouge","Yellow Pop"];

let sheetData = [];
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = function() {
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    addLotRow(); loadAllData();
};

function switchTab(tab, btn) {
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
}

// Date Fix
function getLocalISO(dt) {
    let d = new Date(dt);
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0][0] === "Date") sheetData.shift();
        renderRecentTable();
    } catch(e) {}
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const fDate = document.getElementById('recentFilter').value;
    tb.innerHTML = "";
    sheetData.filter(r => getLocalISO(r[0]) === fDate).reverse().forEach(r => {
        let idx = sheetData.indexOf(r);
        tb.innerHTML += `<tr>
            <td>${new Date(r[0]).toLocaleDateString()}</td><td>L${r[1]}</td><td>${r[3]}</td><td><b>${r[5]}</b></td><td>${r[6]}</td>
            <td><span class="${r[8]==='Pass'?'status-pass':'status-fail'}">${r[8]}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editRec(${idx})">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deleteRec(${idx})">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
}

function showDaySummary() {
    const fDate = document.getElementById('recentFilter').value;
    let dayData = sheetData.filter(r => getLocalISO(r[0]) === fDate);
    if(!dayData.length) return alert("No data!");

    let pLots=0, fLots=0, tQty=0, pQty=0;
    let floors = {"Floor 1":{tQ:0, pQ:0, tL:0, pL:0}, "Floor 2":{tQ:0, pQ:0, tL:0, pL:0}, "Basement":{tQ:0, pQ:0, tL:0, pL:0}};
    let rejects = [];

    dayData.forEach(r => {
        let q = parseInt(r[6]||0), fl = r[2] || "Floor 1";
        tQty += q; floors[fl].tQ += q; floors[fl].tL++;
        if(r[8]==='Pass') { pLots++; pQty += q; floors[fl].pL++; floors[fl].pQ += q; }
        else { fLots++; rejects.push(r); }
    });

    let passRate = tQty > 0 ? ((pQty / tQty) * 100).toFixed(2) : 0;
    document.getElementById('summaryBody').innerHTML = `
        <div class="row g-3 mb-4 mt-2">
            <div class="col-md-3"><div class="preview-card c-total"><div>TOTAL LOTS</div><h2 class="fw-bold">${pLots+fLots}</h2><small>Units: ${tQty}</small></div></div>
            <div class="col-md-3"><div class="preview-card c-pass"><div>PASSED LOTS</div><h2 class="fw-bold">${pLots}</h2><small>Units: ${pQty}</small></div></div>
            <div class="col-md-3"><div class="preview-card c-reject"><div>REJECTED LOTS</div><h2 class="fw-bold">${fLots}</h2><small>Units: ${tQty-pQty}</small></div></div>
            <div class="col-md-3"><div class="preview-card c-rate"><div>PASS RATE %</div><h2 class="fw-bold">${passRate}%</h2></div></div>
        </div>
        <table class="table table-bordered text-center mb-4">
            <thead class="table-light"><tr><th>Floor</th><th>Lots</th><th>Pass</th><th>Total Qty</th><th>Pass Qty</th><th>Rate %</th></tr></thead>
            <tbody>${Object.keys(floors).map(f => `<tr><td>${f}</td><td>${floors[f].tL}</td><td>${floors[f].pL}</td><td>${floors[f].tQ}</td><td>${floors[f].pQ}</td><td>${floors[f].tQ ? ((floors[f].pQ/floors[f].tQ)*100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody>
        </table>
        <h5 class="text-danger">Rejected Detail</h5>
        <table class="table table-striped text-center">
            <thead class="table-danger"><tr><th>Line</th><th>Model</th><th>ID</th><th>Qty</th><th>Status</th><th>Defect</th></tr></thead>
            <tbody>${rejects.map(r => `<tr><td>L${r[1]}</td><td>${r[3]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[9]||"-"}</td></tr>`).join('')}</tbody>
        </table>
    `;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function addLotRow(data = null) {
    const tr = document.createElement('tr'); tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">L${i}</option>`;
    tr.innerHTML = `
        <td><select class="form-select i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control i-id" required style="text-transform:uppercase;"></td>
        <td><input type="number" class="form-control i-qty" required></td>
        <td><select class="form-select i-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select i-res fw-bold" onchange="this.closest('tr').querySelector('.i-rem').disabled=(this.value==='Pass')"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control i-rem" placeholder="Remarks" disabled></td>
        <td><button type="button" class="btn btn-danger" onclick="this.closest('tr').remove()">‚úñ</button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);
    if(data) {
        tr.querySelector('.i-line').value = data[1]; tr.querySelector('.i-model').value = data[3];
        tr.querySelector('.i-color').value = data[4]; tr.querySelector('.i-id').value = data[5];
        tr.querySelector('.i-qty').value = data[6]; tr.querySelector('.i-status').value = data[7];
        tr.querySelector('.i-res').value = data[8]; if(data[8]==='Fail'){ tr.querySelector('.i-rem').disabled=false; tr.querySelector('.i-rem').value=data[9]; }
    }
}

// MAIN SUBMIT LOGIC (FIXED)
document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    const editIdx = document.getElementById('editRowIndex').value;
    document.getElementById('loader').style.display='flex';
    
    let rows = [];
    document.querySelectorAll('.input-row').forEach(tr => {
        let l = tr.querySelector('.i-line').value;
        rows.push([document.getElementById('entryDate').value, l, (l<=8?"Floor 1":(l<=16?"Floor 2":"Basement")), tr.querySelector('.i-model').value, tr.querySelector('.i-color').value, tr.querySelector('.i-id').value.toUpperCase(), tr.querySelector('.i-qty').value, tr.querySelector('.i-status').value, tr.querySelector('.i-res').value, tr.querySelector('.i-rem').value||""]);
    });

    let payload;
    if (editIdx && editIdx !== "") {
        payload = { action: 'edit', rowIndex: parseInt(editIdx), data: rows[0] };
    } else {
        payload = { action: 'save', data: rows };
    }

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        resetForm(); await loadAllData();
    } catch (err) { alert("Error!"); }
    document.getElementById('loader').style.display='none';
};

async function deleteRec(idx) {
    if(!confirm("Delete?")) return; document.getElementById('loader').style.display='flex';
    await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex: idx + 2})});
    await loadAllData();
}

function editRec(idx) {
    const r = sheetData[idx];
    document.getElementById('editRowIndex').value = (idx + 2);
    document.getElementById('entryDate').value = getLocalISO(r[0]);
    document.getElementById('lotContainer').innerHTML=""; addLotRow(r);
    document.getElementById('saveBtn').innerText="UPDATE RECORD";
    document.getElementById('saveBtn').className="btn btn-lg btn-warning px-5 fw-bold";
    document.getElementById('mainEntryCard').className="card p-4 edit-mode-bg";
    document.getElementById('addRowBtn').style.display = 'none'; // Lock multiple rows during edit
    window.scrollTo(0,0);
}

function resetForm() {
    document.getElementById('pdiForm').reset();
    document.getElementById('editRowIndex').value = "";
    document.getElementById('lotContainer').innerHTML = ""; addLotRow();
    document.getElementById('saveBtn').innerText="SAVE TO SHEET";
    document.getElementById('saveBtn').className="btn btn-lg btn-success px-5 fw-bold";
    document.getElementById('mainEntryCard').className="card p-4";
    document.getElementById('addRowBtn').style.display = 'inline-block';
}
</script>
</body>
</html>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #002244; --accent: #007bff; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 24px; }
        .app-header { background: var(--primary); color: white; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo { height: 50px; }
        .nav-pills .nav-link { color: #cbd5e0; font-weight: 500; padding: 12px 25px; font-size: 22px; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .kpi-box { background: white; padding: 20px; border-radius: 10px; border-left: 8px solid var(--accent); text-align: center; }
        .kpi-val { font-size: 42px; font-weight: 800; color: var(--primary); }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .status-pass { background: #e6fffa; color: #234e52; padding: 5px 12px; border-radius: 6px; font-weight: bold; }
        .status-fail { background: #fff5f5; color: #822727; padding: 5px 12px; border-radius: 6px; font-weight: bold; }
        .preview-card { border-radius: 12px; color: white; padding: 20px; text-align: center; }
        .c-total { background: #002244; } .c-pass { background: #28a745; } .c-reject { background: #dc3545; } .c-rate { background: #17a2b8; }
        /* Edit Mode Highlight */
        .edit-active { background-color: #fff3cd !important; border: 2px solid #ffc107 !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
    <div class="mt-3 fw-bold fs-3">Processing...</div>
</div>

<div class="app-header no-print">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h5 class="m-0 fw-bold text-white">PDI MASTER SYSTEM</h5>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)">Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard', this)">Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure', this)">Closure</button>
    </div>
</div>

<div class="container-fluid mt-4">
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex" value="">
            <div class="card p-4" id="formCard">
                <div class="row g-4 align-items-center">
                    <div class="col-md-3">
                        <label class="fw-bold">Report Date</label>
                        <input type="date" id="entryDate" class="form-control" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-outline-primary btn-lg fw-bold" id="addRowBtn" onclick="addLotRow()">+ ADD ROW</button>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0" style="min-width: 1400px;">
                        <thead class="table-light text-center">
                            <tr><th>Line</th><th>Model</th><th>Colour</th><th>Lot ID</th><th>Qty</th><th>Status</th><th>Result</th><th>Defect / Remarks</th><th></th></tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-end mt-4 mb-5">
                <button type="button" class="btn btn-lg btn-light border" onclick="resetForm()">Cancel</button>
                <button type="submit" id="saveBtn" class="btn btn-lg btn-success px-5 fw-bold">SAVE TO SHEET</button>
            </div>
        </form>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Recent Records (Date-Wise Filter)</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control w-auto" onchange="renderRecentTable()">
                    <button class="btn btn-primary fw-bold" onclick="showDaySummary()">View Preview</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center">
                    <thead class="table-dark">
                        <tr><th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Action</th></tr>
                    </thead>
                    <tbody id="crudTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DASHBOARD TAB (ORIGINAL) -->
    <div id="tab-dashboard" style="display:none;">
        <div class="card p-4 mb-4 no-print">
            <div class="row g-4 align-items-end">
                <div class="col-md-3"><label class="fw-bold">From</label><input type="date" id="dashFrom" class="form-control"></div>
                <div class="col-md-3"><label class="fw-bold">To</label><input type="date" id="dashTo" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary btn-lg w-100" onclick="runDashboardAnalysis()">Filter</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger btn-lg" onclick="downloadPDF()">Download PDF</button></div>
            </div>
        </div>
        <div id="pdf-content">
            <div class="row g-4 mb-5 text-center">
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="d_lots">0</div><div>Total Lots</div></div></div>
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val" id="d_qty">0</div><div>Total Qty</div></div></div>
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val text-success" id="d_lar">0%</div><div>Overall LAR %</div></div></div>
                <div class="col-md-3"><div class="kpi-box"><div class="kpi-val text-primary" id="d_pass">0%</div><div>Pass Rate %</div></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header">Trend</div><div class="card-body"><div id="ch_trend" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header">Line Performance</div><div class="card-body"><div id="ch_line" style="height:350px"></div></div></div></div>
                <div class="col-md-5"><div class="card"><div class="card-header">Floor Pass %</div><div class="card-body"><div id="ch_floor" style="height:350px"></div></div></div></div>
                <div class="col-md-7"><div class="card"><div class="card-header">Defects</div><div class="card-body"><div id="ch_defects" style="height:350px"></div></div></div></div>
            </div>
        </div>
    </div>

    <!-- CLOSURE TAB -->
    <div id="tab-closure" style="display:none;">
        <div class="alert alert-info py-3 fs-5"><strong>Pending Lots</strong></div>
        <div class="row g-4 mb-5"><div class="col-md-4"><div class="card-body" id="list_f1"></div></div><div class="col-md-4"><div class="card-body" id="list_f2"></div></div><div class="col-md-4"><div class="card-body" id="list_fb"></div></div></div>
        <div class="card"><div class="table-responsive"><table class="table table-bordered text-center"><tbody id="lotRateTableBody"></tbody></table></div></div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 50px;"><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body pt-0" id="summaryBody"></div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyvBKmQ9GDPwPJXiSBh7En0YPTrJ3uemT7T6nlx-j9EGLJI6fPHXGRhExla4ImSfFyf/exec";

const MODELS = ["Unity ANC","Ace","111v2","131 Elite Anc","131 Gen 2","141 Anc","161 Anc","161 N","181 Pro","191 Anc","192","212","280 Anc","300","71","800","91","Ace Gen 2","Hype","Kick","Nirvana Crystal","Nirvana Iris","Nirvana X","Plus 311","Prime 412","Primo","Pulse","Supreme","Ultra Pro","100","121 Pro","131","141","161","161 Pro-Buds","181","190","191 G","207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","HMD P50","HMD S60","HMD X50","IMT 100","IMT121","IMT131","IMT161","Joy","Max","Nirvana","Nirvana Ion","R 195 Pro","Ultra Plus","Zing"];
const COLOURS = ["Black","Blue","Bold Blue","Crimson Cream","Graphite Grey","Ivory White","Krypton Blue","Lavender Rush","Moon White","Pine Green","Space Grey","Sterling Silver","White","Zinc White","Active Black","Active Teal","Aqua Blue","Ash Grey","Assassin Black","Azure Blue","Berry Blue","Carbon Black","Charcoal Black","Cherry Blossom","Cool Grey","Cosmic Onyx","Cream White","Crimsom Red","Crystal Black","Cyan cider","Deep Blue","Electric Blue","Emerald Green","Frost White","Galactic Purple","Gunmetal Black","Ice Blue","Ivory","Jet Black","Lunar White","Maroon Lush","Martian Green","Metallic Grey","Midnight Black","Midnight Blue","Mint Blue","Mist Grey","Mystic Blue","Noir Black","Ocean Blue","Olive Green","Opal Black","Orange","Peach Blush","Pearl White","Pellucid Blue","Purple","Quantum Black","Red","Rose Quartz","Saga Green","Sandstone","Shadow Black","Silver","Slate Grey","Sleek Black","Sonic Silver","Spirit White","Sporty Blue","Starry Blue","Sunset Blush","Teal","Thunder Blue","Velvet Rouge","Yellow Pop"];

let sheetData = [];
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = function() {
    let today = new Date().toISOString().split('T')[0];
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    document.getElementById('dashFrom').value = today;
    document.getElementById('dashTo').value = today;
    addLotRow();
    loadAllData();
};

function switchTab(tab, btn) {
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
    if(tab === 'dashboard') runDashboardAnalysis();
    if(tab === 'closure') runClosureReport();
}

function getLocalISO(dt) {
    let d = new Date(dt);
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0][0] === "Date") sheetData.shift();
        renderRecentTable();
    } catch(e) {}
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const fDate = document.getElementById('recentFilter').value;
    tb.innerHTML = "";
    sheetData.filter(r => getLocalISO(r[0]) === fDate).reverse().forEach(r => {
        let idx = sheetData.indexOf(r);
        tb.innerHTML += `<tr>
            <td>${new Date(r[0]).toLocaleDateString()}</td><td>L${r[1]}</td><td>${r[3]}</td><td><b>${r[5]}</b></td><td>${r[6]}</td>
            <td><span class="${r[8]==='Pass'?'status-pass':'status-fail'}">${r[8]}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editRec(${idx})">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deleteRec(${idx})">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
}

function showDaySummary() {
    const fDate = document.getElementById('recentFilter').value;
    let dayData = sheetData.filter(r => getLocalISO(r[0]) === fDate);
    if(!dayData.length) return alert("No data!");

    let pLots=0, fLots=0, tQty=0, pQty=0;
    let floors = {"Floor 1":{tQ:0, pQ:0, tL:0, pL:0}, "Floor 2":{tQ:0, pQ:0, tL:0, pL:0}, "Basement":{tQ:0, pQ:0, tL:0, pL:0}};
    let rejects = [];

    dayData.forEach(r => {
        let q = parseInt(r[6]||0), fl = r[2] || "Floor 1";
        tQty += q; floors[fl].tQ += q; floors[fl].tL++;
        if(r[8]==='Pass') { pLots++; pQty += q; floors[fl].pL++; floors[fl].pQ += q; }
        else { fLots++; rejects.push(r); }
    });

    let passRate = tQty > 0 ? ((pQty / tQty) * 100).toFixed(2) : 0;
    document.getElementById('summaryBody').innerHTML = `
        <div class="row g-3 mb-4 mt-2">
            <div class="col-md-3"><div class="preview-card c-total"><div>TOTAL LOTS</div><h2 class="fw-bold">${pLots+fLots}</h2><small>Units: ${tQty}</small></div></div>
            <div class="col-md-3"><div class="preview-card c-pass"><div>PASSED LOTS</div><h2 class="fw-bold">${pLots}</h2><small>Units: ${pQty}</small></div></div>
            <div class="col-md-3"><div class="preview-card c-reject"><div>REJECTED LOTS</div><h2 class="fw-bold">${fLots}</h2><small>Units: ${tQty-pQty}</small></div></div>
            <div class="col-md-3"><div class="preview-card c-rate"><div>PASS RATE %</div><h2 class="fw-bold">${passRate}%</h2></div></div>
        </div>
        <table class="table table-bordered text-center mb-4"><thead class="table-light"><tr><th>Floor</th><th>Lots</th><th>Pass</th><th>Total Qty</th><th>Pass Qty</th><th>Rate %</th></tr></thead>
        <tbody>${Object.keys(floors).map(f => `<tr><td>${f}</td><td>${floors[f].tL}</td><td>${floors[f].pL}</td><td>${floors[f].tQ}</td><td>${floors[f].pQ}</td><td>${floors[f].tQ ? ((floors[f].pQ/floors[f].tQ)*100).toFixed(1) : 0}%</td></tr>`).join('')}</tbody></table>
        <h5 class="text-danger">Rejected Lots</h5>
        <table class="table table-striped text-center"><thead class="table-danger"><tr><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Status</th><th>Defect</th></tr></thead>
        <tbody>${rejects.map(r => `<tr><td>L${r[1]}</td><td>${r[3]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[9]||"-"}</td></tr>`).join('')}</tbody></table>
    `;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function addLotRow(data = null) {
    const tr = document.createElement('tr'); tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">L${i}</option>`;
    tr.innerHTML = `
        <td><select class="form-select i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control i-id" required style="text-transform:uppercase;"></td>
        <td><input type="number" class="form-control i-qty" required></td>
        <td><select class="form-select i-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select i-res fw-bold" onchange="this.closest('tr').querySelector('.i-rem').disabled=(this.value==='Pass')"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control i-rem" placeholder="Remarks" disabled></td>
        <td><button type="button" class="btn btn-danger" onclick="this.closest('tr').remove()">‚úñ</button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);
    if(data) {
        tr.querySelector('.i-line').value = data[1]; tr.querySelector('.i-model').value = data[3];
        tr.querySelector('.i-color').value = data[4]; tr.querySelector('.i-id').value = data[5];
        tr.querySelector('.i-qty').value = data[6]; tr.querySelector('.i-status').value = data[7];
        tr.querySelector('.i-res').value = data[8]; if(data[8]==='Fail'){ tr.querySelector('.i-rem').disabled=false; tr.querySelector('.i-rem').value=data[9]; }
    }
}

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    const editIdx = document.getElementById('editRowIndex').value;
    document.getElementById('loader').style.display='flex';
    
    let rows = [];
    document.querySelectorAll('.input-row').forEach(tr => {
        let l = tr.querySelector('.i-line').value;
        rows.push([document.getElementById('entryDate').value, l, (l<=8?"Floor 1":(l<=16?"Floor 2":"Basement")), tr.querySelector('.i-model').value, tr.querySelector('.i-color').value, tr.querySelector('.i-id').value.toUpperCase(), tr.querySelector('.i-qty').value, tr.querySelector('.i-status').value, tr.querySelector('.i-res').value, tr.querySelector('.i-rem').value||""]);
    });

    let payload = (editIdx && editIdx !== "") ? { action: 'edit', rowIndex: parseInt(editIdx), data: rows[0] } : { action: 'save', data: rows };

    try {
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        resetForm(); await loadAllData();
    } catch (err) { alert("Error!"); }
    document.getElementById('loader').style.display='none';
};

async function deleteRec(idx) {
    if(!confirm("Delete?")) return; document.getElementById('loader').style.display='flex';
    await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex: idx + 2})});
    await loadAllData();
}

function editRec(idx) {
    const r = sheetData[idx];
    document.getElementById('editRowIndex').value = (idx + 2);
    document.getElementById('entryDate').value = getLocalISO(r[0]);
    document.getElementById('lotContainer').innerHTML=""; addLotRow(r);
    document.getElementById('saveBtn').innerText="UPDATE RECORD";
    document.getElementById('saveBtn').className="btn btn-lg btn-warning px-5 fw-bold";
    document.getElementById('formCard').className="card p-4 edit-active";
    document.getElementById('addRowBtn').style.display = 'none';
    window.scrollTo(0,0);
}

function resetForm() {
    document.getElementById('pdiForm').reset();
    document.getElementById('editRowIndex').value = "";
    document.getElementById('lotContainer').innerHTML = ""; addLotRow();
    document.getElementById('saveBtn').innerText = "SAVE TO SHEET";
    document.getElementById('saveBtn').className = "btn btn-lg btn-success px-5 fw-bold";
    document.getElementById('formCard').className = "card p-4";
    document.getElementById('addRowBtn').style.display = 'inline-block';
}

function runDashboardAnalysis() {
    const from = document.getElementById('dashFrom').value, to = document.getElementById('dashTo').value;
    let dLots=0, dQty=0, pLots=0, pQty=0, dates={}, lines={}, floors={"Floor 1":{p:0,t:0},"Floor 2":{p:0,t:0},"Basement":{p:0,t:0}};
    sheetData.forEach(r => {
        let rd = getLocalISO(r[0]);
        if(rd >= from && rd <= to) {
            let q = parseInt(r[6]||0), ln = "L"+r[1], fl = r[2], res = r[8];
            dLots++; dQty += q; if(!dates[rd]) dates[rd]={p:0,t:0}; if(!lines[ln]) lines[ln]={p:0,t:0};
            dates[rd].t += q; lines[ln].t += q; if(floors[fl]) floors[fl].t += q;
            if(res === 'Pass') { pLots++; pQty += q; dates[rd].p += q; lines[ln].p += q; if(floors[fl]) floors[fl].p += q; }
        }
    });
    document.getElementById('d_lots').innerText = dLots; document.getElementById('d_qty').innerText = dQty;
    document.getElementById('d_lar').innerText = (dLots?(pLots/dLots*100).toFixed(1):0)+"%";
    document.getElementById('d_pass').innerText = (dQty?(pQty/dQty*100).toFixed(1):0)+"%";
    new google.visualization.LineChart(document.getElementById('ch_trend')).draw(google.visualization.arrayToDataTable([['Date','Pass Rate %'], ...Object.keys(dates).sort().map(k=>[k, (dates[k].p/dates[k].t*100)])]), {legend:'none', colors:['#007bff']});
}

function runClosureReport() {
    let lotStatus = {}; sheetData.forEach(r => { lotStatus[r[5]] = {res:r[8], fl:r[2], mod:r[3]}; });
    const f1=document.getElementById('list_f1'), f2=document.getElementById('list_f2'), fb=document.getElementById('list_fb');
    f1.innerHTML=f2.innerHTML=fb.innerHTML="";
    Object.keys(lotStatus).forEach(id => {
        if(lotStatus[id].res !== 'Pass') {
            let item = `<div class="p-2 border mb-1"><b>${id}</b> - ${lotStatus[id].mod}</div>`;
            if(lotStatus[id].fl==='Floor 1') f1.innerHTML += item; else if(lotStatus[id].fl==='Floor 2') f2.innerHTML += item; else fb.innerHTML += item;
        }
    });
}
function downloadPDF() { html2pdf().set({ margin: 0.3, filename: 'PDI_Report.pdf', jsPDF: { orientation: 'landscape' } }).from(document.getElementById('pdf-content')).save(); }
</script>
</body>
</html>
