<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master Pro v12.0 (Smart Closure & Graph Labels)</title>
    
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- THEME COLORS --- */
        :root { 
            --primary: #0f172a; 
            --secondary: #334155; 
            --accent: #3b82f6; 
            --success: #10b981; 
            --danger: #ef4444; 
            --bg-light: #f8fafc;
        }

        /* --- BIG FONTS --- */
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; font-size: 18px; color: var(--primary); }
        .form-control, .form-select, .btn { font-size: 18px; padding: 12px; border-radius: 8px; }
        
        /* --- HEADER & NAV --- */
        .app-header { background: var(--primary); padding: 15px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo-box { background: white; padding: 5px 12px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .nav-pills .nav-link { color: #94a3b8; font-weight: 600; padding: 12px 25px; border-radius: 8px; font-size: 18px; transition: 0.3s; }
        .nav-pills .nav-link.active { background-color: var(--accent); color: white; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4); }
        .nav-pills .nav-link:hover:not(.active) { color: white; background: rgba(255,255,255,0.1); }

        /* --- CARDS & SHADOWS --- */
        .card { border: none; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); background: white; margin-bottom: 25px; overflow: hidden; }
        .card-header { background: white; border-bottom: 2px solid #f1f5f9; padding: 15px 20px; font-weight: 700; color: var(--secondary); font-size: 1.1rem; }
        
        /* --- STAT CARDS --- */
        .stat-card { padding: 25px; border-radius: 16px; position: relative; overflow: hidden; transition: transform 0.2s; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.05); border-bottom: 4px solid transparent; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { position: absolute; right: 20px; top: 20px; font-size: 3.5rem; opacity: 0.1; }
        .stat-val { font-size: 3rem; font-weight: 800; line-height: 1; margin: 10px 0; }
        .stat-label { font-size: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #64748b; }
        .stat-sub { font-size: 0.9rem; color: #94a3b8; font-weight: 600; margin-top: 5px; }
        
        .b-blue { border-color: var(--accent); color: var(--accent); }
        .b-green { border-color: var(--success); color: var(--success); }
        .b-red { border-color: var(--danger); color: var(--danger); }
        .b-dark { border-color: var(--primary); color: var(--primary); }

        /* --- CLOSURE TICKETS --- */
        .closure-col { background: #e2e8f0; border-radius: 12px; padding: 15px; height: 100%; min-height: 400px; }
        .closure-header { text-align: center; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; color: var(--secondary); padding-bottom: 10px; border-bottom: 2px solid #cbd5e1; }
        .ticket { background: white; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 6px solid var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .ticket:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .ticket-id { font-weight: 800; font-size: 1.1em; color: var(--primary); }
        .ticket-defect { color: var(--danger); font-size: 0.95em; margin-top: 5px; font-weight: 600; }

        /* --- TABLE --- */
        .table th { background: #f8fafc; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.5px; padding: 15px; font-weight: 700; color: #475569; }
        .table td { padding: 15px; vertical-align: middle; font-weight: 500; }
        .st-pass { background: #dcfce7; color: #166534; padding: 6px 15px; border-radius: 20px; font-weight: 700; }
        .st-fail { background: #fee2e2; color: #991b1b; padding: 6px 15px; border-radius: 20px; font-weight: 700; }

        /* --- MODAL --- */
        .modal-header { background: var(--primary); color: white; }
        .pro-table .total-row { background: var(--primary) !important; color: white; font-size: 1.2em; font-weight: bold; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .edit-active { background-color: #fffbeb !important; border: 2px dashed #f59e0b !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
    <div class="mt-3 fw-bold fs-4">Syncing Data...</div>
</div>

<!-- HEADER -->
<div class="app-header no-print d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
        <div class="logo-box">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 40px;">
        </div>
        <div>
            <h4 class="m-0 fw-bold text-white tracking-wide">PDI MASTER <span style="color: var(--accent);">PRO</span></h4>
        </div>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form', this)"><i class="bi bi-pencil-square me-2"></i>Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard', this)"><i class="bi bi-bar-chart-fill me-2"></i>Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure', this)"><i class="bi bi-exclamation-octagon-fill me-2"></i>Closure</button>
    </div>
</div>

<div class="container-fluid mt-4 px-4">
    
    <!-- === ENTRY TAB === -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex" value="">
            <div class="card p-4" id="formCard">
                <div class="row g-4 align-items-end">
                    <div class="col-md-3">
                        <label class="fw-bold text-secondary mb-2">REPORT DATE</label>
                        <input type="date" id="entryDate" class="form-control fw-bold shadow-sm" required>
                    </div>
                    <div class="col-md-9 text-end">
                        <button type="button" class="btn btn-outline-primary shadow-sm" id="addRowBtn" onclick="addLotRow()">
                            <i class="bi bi-plus-lg me-2"></i>ADD NEW LINE
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-4 overflow-hidden shadow">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0 text-center table-hover" style="min-width: 1500px;">
                        <thead>
                            <tr>
                                <th width="8%">LINE</th><th width="15%">MODEL</th><th width="12%">COLOUR</th>
                                <th width="12%">LOT ID</th><th width="8%">QTY</th><th width="10%">STATUS</th>
                                <th width="10%">RESULT</th><th>REMARKS / DEFECT</th><th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4 mb-5">
                <button type="button" class="btn btn-light border px-4" onclick="resetForm()">Reset</button>
                <button type="submit" id="saveBtn" class="btn btn-primary px-5 shadow fw-bold"><i class="bi bi-cloud-arrow-up-fill me-2"></i>SAVE RECORDS</button>
            </div>
        </form>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>RECENT ENTRIES</span>
                <div class="d-flex gap-2">
                    <input type="date" id="recentFilter" class="form-control w-auto py-1" onchange="renderRecentTable()">
                    <button class="btn btn-dark btn-sm px-4" onclick="showDaySummary()"><i class="bi bi-eye-fill me-2"></i>PREVIEW REPORT</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover text-center align-middle mb-0">
                    <thead class="table-dark"><tr><th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Qty</th><th>Result</th><th>Action</th></tr></thead>
                    <tbody id="crudTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- === DASHBOARD TAB === -->
    <div id="tab-dashboard" style="display:none;">
        <div class="card p-4 mb-4 no-print">
            <div class="row g-4 align-items-end">
                <div class="col-md-3"><label class="fw-bold text-muted">From Date</label><input type="date" id="dashFrom" class="form-control"></div>
                <div class="col-md-3"><label class="fw-bold text-muted">To Date</label><input type="date" id="dashTo" class="form-control"></div>
                <div class="col-md-2"><button class="btn btn-primary w-100 fw-bold" onclick="runDashboardAnalysis()">FILTER DATA</button></div>
                <div class="col-md-4 text-end"><button class="btn btn-danger shadow-sm" onclick="downloadPDF()"><i class="bi bi-file-pdf-fill me-2"></i>Download PDF</button></div>
            </div>
        </div>
        
        <div id="pdf-content">
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="stat-card b-dark">
                        <i class="bi bi-box-seam stat-icon"></i>
                        <div class="stat-val" id="d_lots">0</div>
                        <div class="stat-label">Total Lots</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card b-blue">
                        <i class="bi bi-layers-half stat-icon"></i>
                        <div class="stat-val" id="d_qty">0</div>
                        <div class="stat-label">Total Qty</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card b-green">
                        <i class="bi bi-check-circle-fill stat-icon"></i>
                        <div class="stat-val" id="d_pass">0%</div>
                        <div class="stat-label">Pass Rate (Qty)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card b-red">
                        <i class="bi bi-exclamation-triangle-fill stat-icon"></i>
                        <div class="stat-val" id="d_lar">0%</div>
                        <div class="stat-label">Reject Rate</div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6"><div class="card h-100"><div class="card-header">Daily Production Trend</div><div class="card-body"><div id="ch_trend" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card h-100"><div class="card-header">Line-wise Performance</div><div class="card-body"><div id="ch_line" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card h-100"><div class="card-header">Floor-wise Pass % (Qty Based)</div><div class="card-body"><div id="ch_floor" style="height:350px"></div></div></div></div>
                <div class="col-md-6"><div class="card h-100"><div class="card-header">Top 5 Defects</div><div class="card-body"><div id="ch_defects" style="height:350px"></div></div></div></div>
            </div>
        </div>
    </div>

    <!-- === CLOSURE TAB === -->
    <div id="tab-closure" style="display:none;">
        <div class="alert alert-light border shadow-sm p-4 mb-4 d-flex align-items-center">
            <i class="bi bi-info-circle-fill text-primary fs-3 me-3"></i>
            <div>
                <h5 class="fw-bold m-0">Pending Actions / Rework</h5>
                <small class="text-muted">Only lots that have <strong>NOT</strong> passed yet are shown here.</small>
            </div>
        </div>
        
        <div class="row g-4" style="min-height: 500px;">
            <div class="col-md-4"><div class="closure-col"><div class="closure-header text-primary">Floor 1</div><div id="list_f1"></div></div></div>
            <div class="col-md-4"><div class="closure-col"><div class="closure-header text-success">Floor 2</div><div id="list_f2"></div></div></div>
            <div class="col-md-4"><div class="closure-col"><div class="closure-header text-dark">Basement</div><div id="list_fb"></div></div></div>
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div class="modal fade" id="summaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center gap-3">
                    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height: 35px;" class="bg-white rounded px-2">
                    <h5 class="m-0 fw-bold">Daily Production Summary</h5>
                </div>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4" id="summaryBody"></div>
            <div class="modal-footer bg-white">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary" onclick="window.print()">Print Report</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyvBKmQ9GDPwPJXiSBh7En0YPTrJ3uemT7T6nlx-j9EGLJI6fPHXGRhExla4ImSfFyf/exec";
const MODELS = ["Unity ANC","Ace","111v2","131 Elite Anc","131 Gen 2","141 Anc","161 Anc","161 N","181 Pro","191 Anc","192","212","280 Anc","300","71","800","91","Ace Gen 2","Hype","Kick","Nirvana Crystal","Nirvana Iris","Nirvana X","Plus 311","Prime 412","Primo","Pulse","Supreme","Ultra Pro","100","121 Pro","131","141","161","161 Pro-Buds","181","190","191 G","207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","HMD P50","HMD S60","HMD X50","IMT 100","IMT121","IMT131","IMT161","Joy","Max","Nirvana","Nirvana Ion","R 195 Pro","Ultra Plus","Zing"];
const COLOURS = ["Black","Blue","Bold Blue","Crimson Cream","Graphite Grey","Ivory White","Krypton Blue","Lavender Rush","Moon White","Pine Green","Space Grey","Sterling Silver","White","Zinc White","Active Black","Active Teal","Aqua Blue","Ash Grey","Assassin Black","Azure Blue","Berry Blue","Carbon Black","Charcoal Black","Cherry Blossom","Cool Grey","Cosmic Onyx","Cream White","Crimsom Red","Crystal Black","Cyan cider","Deep Blue","Electric Blue","Emerald Green","Frost White","Galactic Purple","Gunmetal Black","Ice Blue","Ivory","Jet Black","Lunar White","Maroon Lush","Martian Green","Metallic Grey","Midnight Black","Midnight Blue","Mint Blue","Mist Grey","Mystic Blue","Noir Black","Ocean Blue","Olive Green","Opal Black","Orange","Peach Blush","Pearl White","Pellucid Blue","Purple","Quantum Black","Red","Rose Quartz","Saga Green","Sandstone","Shadow Black","Silver","Slate Grey","Sleek Black","Sonic Silver","Spirit White","Sporty Blue","Starry Blue","Sunset Blush","Teal","Thunder Blue","Velvet Rouge","Yellow Pop"];

let sheetData = [];
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = function() {
    let today = new Date().toLocaleDateString('en-CA');
    document.getElementById('entryDate').value = today;
    document.getElementById('recentFilter').value = today;
    document.getElementById('dashFrom').value = today;
    document.getElementById('dashTo').value = today;
    addLotRow();
    loadAllData();
};

function switchTab(tab, btn) {
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
    if(tab === 'dashboard') runDashboardAnalysis();
    if(tab === 'closure') runClosureReport();
}

function getCleanDate(isoString) { if(!isoString) return ""; let d = new Date(isoString); return d.toLocaleDateString('en-CA'); }
function formatDateDisplay(isoString) { if(!isoString) return ""; let d = new Date(isoString); return d.getDate().toString().padStart(2,'0') + '/' + (d.getMonth()+1).toString().padStart(2,'0') + '/' + d.getFullYear(); }

async function loadAllData() {
    document.getElementById('loader').style.display='flex';
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        sheetData = json.data;
        if(sheetData[0] && sheetData[0][0] === "Date") sheetData.shift(); 
        renderRecentTable();
    } catch(e) { console.error(e); }
    document.getElementById('loader').style.display='none';
}

function renderRecentTable() {
    const tb = document.getElementById('crudTable');
    const fDate = document.getElementById('recentFilter').value;
    tb.innerHTML = "";
    sheetData.slice().reverse().forEach(r => {
        if (getCleanDate(r[0]) === fDate) {
            let idx = sheetData.indexOf(r);
            tb.innerHTML += `<tr>
                <td>${formatDateDisplay(r[0])}</td><td>L${r[1]}</td><td>${r[3]}</td><td class="fw-bold">${r[5]}</td><td>${r[6]}</td>
                <td><span class="${r[8]==='Pass'?'st-pass':'st-fail'}">${r[8]}</span></td>
                <td><button class="btn btn-light border btn-sm text-primary" onclick="editRec(${idx})"><i class="bi bi-pencil-fill"></i></button>
                    <button class="btn btn-light border btn-sm text-danger" onclick="deleteRec(${idx})"><i class="bi bi-trash-fill"></i></button></td>
            </tr>`;
        }
    });
}

function showDaySummary() {
    const fDate = document.getElementById('recentFilter').value;
    let dayData = sheetData.filter(r => getCleanDate(r[0]) === fDate);
    if(!dayData.length) return alert("No data found!");

    let pLots=0, fLots=0, tQty=0, pQty=0;
    let floors = {"Floor 1":{tQ:0, pQ:0, tL:0, pL:0}, "Floor 2":{tQ:0, pQ:0, tL:0, pL:0}, "Basement":{tQ:0, pQ:0, tL:0, pL:0}};
    let rejects = [];

    dayData.forEach(r => {
        let q = parseInt(r[6]||0), fl = r[2] || "Floor 1";
        if(!floors[fl]) floors[fl] = {tQ:0, pQ:0, tL:0, pL:0};
        tQty += q; floors[fl].tQ += q; floors[fl].tL++;
        if(r[8]==='Pass') { pLots++; pQty += q; floors[fl].pL++; floors[fl].pQ += q; } else { fLots++; rejects.push(r); }
    });

    let gLots=0, gPassL=0, gQty=0, gPassQ=0;
    Object.keys(floors).forEach(f => { gLots+=floors[f].tL; gPassL+=floors[f].pL; gQty+=floors[f].tQ; gPassQ+=floors[f].pQ; });
    let gRate = gQty>0 ? ((gPassQ/gQty)*100).toFixed(2) : "0.00";

    document.getElementById('summaryBody').innerHTML = `
        <div class="row g-4 mb-4">
            <div class="col-md-3"><div class="stat-card b-dark py-3"><div class="stat-val">${gQty}</div><div class="stat-label">TOTAL UNITS</div><div class="stat-sub">(Lots: ${gLots})</div></div></div>
            <div class="col-md-3"><div class="stat-card b-green py-3"><div class="stat-val">${gPassQ}</div><div class="stat-label">PASSED UNITS</div><div class="stat-sub">(Lots: ${gPassL})</div></div></div>
            <div class="col-md-3"><div class="stat-card b-red py-3"><div class="stat-val">${gQty-gPassQ}</div><div class="stat-label">REJECTED UNITS</div><div class="stat-sub">(Lots: ${gLots-gPassL})</div></div></div>
            <div class="col-md-3"><div class="stat-card b-blue py-3"><div class="stat-val">${gRate}%</div><div class="stat-label">PASS RATE</div></div></div>
        </div>
        <h6 class="fw-bold mb-3 text-secondary">FLOOR WISE PERFORMANCE - ${fDate.split('-').reverse().join('/')}</h6>
        <div class="card border-0 shadow-sm mb-4">
            <table class="table pro-table mb-0 text-center table-bordered">
                <thead><tr><th class="bg-light">Floor Name</th><th>Lots</th><th>Passed</th><th>Total Qty</th><th>Pass Qty</th><th>Rate %</th></tr></thead>
                <tbody>${Object.keys(floors).map(f => {
                    let rate = floors[f].tQ ? ((floors[f].pQ/floors[f].tQ)*100).toFixed(2) : "0.00";
                    return `<tr><td class="fw-bold text-start ps-4">${f}</td><td>${floors[f].tL}</td><td>${floors[f].pL}</td><td>${floors[f].tQ}</td><td>${floors[f].pQ}</td><td><span class="badge ${rate>=90?'bg-success':(rate>=80?'bg-warning text-dark':'bg-danger')}">${rate}%</span></td></tr>`;
                }).join('')}</tbody>
                <tfoot class="total-row"><tr><td class="text-start ps-4">GRAND TOTAL</td><td>${gLots}</td><td>${gPassL}</td><td>${gQty}</td><td>${gPassQ}</td><td>${gRate}%</td></tr></tfoot>
            </table>
        </div>
        <h6 class="fw-bold text-danger">REJECTED LOTS</h6>
        ${rejects.length > 0 ? `<table class="table table-striped text-center"><thead class="table-danger"><tr><th>Line</th><th>Model</th><th>ID</th><th>Defect</th></tr></thead><tbody>${rejects.map(r => `<tr><td>L${r[1]}</td><td>${r[3]}</td><td class="fw-bold">${r[5]}</td><td class="text-danger">${r[9]}</td></tr>`).join('')}</tbody></table>` : `<div class="alert alert-success">No rejections found!</div>`}
    `;
    new bootstrap.Modal(document.getElementById('summaryModal')).show();
}

function addLotRow(data = null) {
    const tr = document.createElement('tr'); tr.className = 'input-row';
    let lOpts = ''; for(let i=1; i<=21; i++) lOpts += `<option value="${i}">L${i}</option>`;
    tr.innerHTML = `<td><select class="form-select i-line" required><option value="">-</option>${lOpts}</select></td>
        <td><select class="form-select i-model" required><option value="">-</option>${MODELS.map(m=>`<option value="${m}">${m}</option>`).join('')}</select></td>
        <td><select class="form-select i-color" required><option value="">-</option>${COLOURS.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></td>
        <td><input type="text" class="form-control i-id fw-bold text-uppercase" placeholder="ID" required></td>
        <td><input type="number" class="form-control i-qty" placeholder="0" required></td>
        <td><select class="form-select i-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select i-res fw-bold" onchange="toggleRem(this)"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control i-rem" placeholder="Remarks" disabled></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm border-0 px-3" onclick="this.closest('tr').remove()"><i class="bi bi-x-lg"></i></button></td>`;
    document.getElementById('lotContainer').appendChild(tr);
    if(data) {
        tr.querySelector('.i-line').value=data[1]; tr.querySelector('.i-model').value=data[3]; tr.querySelector('.i-color').value=data[4];
        tr.querySelector('.i-id').value=data[5]; tr.querySelector('.i-qty').value=data[6]; tr.querySelector('.i-status').value=data[7];
        tr.querySelector('.i-res').value=data[8]; if(data[8]==='Fail'){ tr.querySelector('.i-rem').disabled=false; tr.querySelector('.i-rem').value=data[9]; }
    }
}
function toggleRem(sel) { const r=sel.closest('tr').querySelector('.i-rem'); r.disabled=(sel.value==='Pass'); if(sel.value==='Pass')r.value=""; else r.focus(); }

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault(); const editIdx = document.getElementById('editRowIndex').value;
    document.getElementById('loader').style.display='flex';
    let rows = []; document.querySelectorAll('.input-row').forEach(tr => { let l = parseInt(tr.querySelector('.i-line').value); rows.push([document.getElementById('entryDate').value, l, (l<=8?"Floor 1":(l<=16?"Floor 2":"Basement")), tr.querySelector('.i-model').value, tr.querySelector('.i-color').value, tr.querySelector('.i-id').value.toUpperCase(), tr.querySelector('.i-qty').value, tr.querySelector('.i-status').value, tr.querySelector('.i-res').value, tr.querySelector('.i-rem').value||""]); });
    try { await fetch(API_URL, { method: 'POST', body: JSON.stringify((editIdx && editIdx !== "") ? { action: 'edit', rowIndex: parseInt(editIdx), data: rows[0] } : { action: 'save', data: rows }) }); resetForm(); await loadAllData(); alert("Saved!"); } catch (err) { alert("Error"); }
    document.getElementById('loader').style.display='none';
};
async function deleteRec(idx) { if(confirm("Delete?")) { document.getElementById('loader').style.display='flex'; await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delete', rowIndex: idx + 2})}); await loadAllData(); } }
function editRec(idx) { const r = sheetData[idx]; document.getElementById('editRowIndex').value = (idx + 2); document.getElementById('entryDate').value = getCleanDate(r[0]); document.getElementById('lotContainer').innerHTML=""; addLotRow(r); document.getElementById('saveBtn').innerHTML = 'UPDATE'; document.getElementById('formCard').className="card p-4 edit-active"; document.getElementById('addRowBtn').style.display='none'; window.scrollTo(0,0); }
function resetForm() { document.getElementById('pdiForm').reset(); document.getElementById('editRowIndex').value=""; document.getElementById('lotContainer').innerHTML=""; addLotRow(); document.getElementById('saveBtn').innerHTML='SAVE RECORDS'; document.getElementById('formCard').className="card p-4"; document.getElementById('addRowBtn').style.display='inline-block'; }

function runDashboardAnalysis() {
    const from = document.getElementById('dashFrom').value, to = document.getElementById('dashTo').value;
    let dLots=0, dQty=0, pLots=0, pQty=0, dates={}, lines={}, floors={}, defects={}; 
    sheetData.forEach(r => {
        let rd = getCleanDate(r[0]);
        if(rd >= from && rd <= to) {
            let q = parseInt(r[6]||0), ln="L"+r[1], fl=r[2], res=r[8], def=r[9];
            dLots++; dQty += q;
            if(!dates[rd]) dates[rd] = {p:0, t:0}; dates[rd].t += q;
            if(!lines[ln]) lines[ln] = {p:0, t:0}; lines[ln].t += q;
            if(!floors[fl]) floors[fl] = {p:0, t:0}; floors[fl].t += q;

            if(res === 'Pass') { 
                pLots++; pQty += q; dates[rd].p += q; lines[ln].p += q; floors[fl].p += q; 
            } else {
                if(def) defects[def] = (defects[def] || 0) + 1;
            }
        }
    });

    document.getElementById('d_lots').innerText = dLots; 
    document.getElementById('d_qty').innerText = dQty;
    document.getElementById('d_lar').innerText = dLots ? (((dLots-pLots)/dLots)*100).toFixed(1)+"%" : "0%";
    document.getElementById('d_pass').innerText = dQty ? ((pQty/dQty)*100).toFixed(1)+"%" : "0%";

    // UPDATED GRAPH FUNCTION: BOLD LABELS IN MIDDLE
    const drawBar = (id, arr, title, isPercent=true) => {
        let chartData = arr.map(row => {
            let val = row[1];
            let label = isPercent ? val.toFixed(1) + "%" : val.toString();
            return [row[0], val, row[2], label]; // Add label column
        });

        let dt = new google.visualization.DataTable();
        dt.addColumn('string', 'Item');
        dt.addColumn('number', 'Value');
        dt.addColumn({type: 'string', role: 'style'});
        dt.addColumn({type: 'string', role: 'annotation'}); // Annotation Role
        dt.addRows(chartData);

        new google.visualization.ColumnChart(document.getElementById(id)).draw(dt, {
            title: title, legend: { position: "none" },
            vAxis: { minValue: 0 },
            chartArea: { width: '85%', height: '75%' },
            annotations: {
                textStyle: { fontSize: 13, bold: true, color: '#000' },
                alwaysOutside: false 
            }
        });
    };

    let dArr = Object.keys(dates).sort().map(d => [formatDateDisplay(d).substr(0,5), (dates[d].t?(dates[d].p/dates[d].t)*100:0), '#0f172a']);
    drawBar('ch_trend', dArr, 'Daily Pass Rate %');

    let lArr = Object.keys(lines).map(l => [l, (lines[l].t?(lines[l].p/lines[l].t)*100:0), '#3b82f6']);
    drawBar('ch_line', lArr, 'Line Pass %');

    let fArr = Object.keys(floors).map(f => [f, (floors[f].t?(floors[f].p/floors[f].t)*100:0), '#10b981']);
    drawBar('ch_floor', fArr, 'Floor Pass %');

    let dfArr = Object.keys(defects).map(d => [d, defects[d], '#ef4444']);
    drawBar('ch_defects', dfArr, 'Defect Counts', false);
}

function runClosureReport() {
    let f1=document.getElementById('list_f1'), f2=document.getElementById('list_f2'), fb=document.getElementById('list_fb');
    f1.innerHTML=f2.innerHTML=fb.innerHTML="";
    
    // SMART LOGIC: Find IDs that have PASSED
    let passedLots = new Set();
    sheetData.forEach(r => { if(r[8] === 'Pass') passedLots.add(r[5]); });

    sheetData.forEach(r => {
        // Show only if Failed AND NOT in passedLots
        if(r[8] !== 'Pass' && !passedLots.has(r[5])) {
            let item = `
            <div class="ticket">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="ticket-id">${r[5]}</span>
                    <span class="badge bg-danger">L${r[1]}</span>
                </div>
                <div class="text-secondary small fw-bold">${r[3]}</div>
                <div class="ticket-defect"><i class="bi bi-bug-fill me-1"></i>${r[9]||"Unspecified"}</div>
                <div class="text-end mt-2"><small class="text-muted">${formatDateDisplay(r[0])}</small></div>
            </div>`;
            if(r[2]==='Floor 1') f1.innerHTML += item;
            else if(r[2]==='Floor 2') f2.innerHTML += item;
            else fb.innerHTML += item;
        }
    });
}
</script>
</body>
</html>
