<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDI Master System - Updated</title>
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 15px; }
        .app-header { background: white; border-bottom: 5px solid #003366; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .logo { height: 55px; }
        .app-title { color: #003366; font-weight: 800; font-size: 24px; text-transform: uppercase; margin: 0; }
        .nav-pills .nav-link { color: #555; font-weight: bold; border: 1px solid #ddd; margin-right: 5px; background: white; }
        .nav-pills .nav-link.active { background-color: #003366; color: white; border-color: #003366; }
        .card { border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .card-header { background: #003366; color: white; font-weight: bold; padding: 12px 15px; border-radius: 8px 8px 0 0 !important; }
        .table thead { background-color: #343a40; color: white; }
        .kpi-box { background: white; padding: 20px; border-radius: 8px; border-left: 6px solid #003366; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .kpi-val { font-size: 32px; font-weight: bold; color: #333; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #003366; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="loader">Processing Data...</div>

<div class="app-header">
    <div class="d-flex align-items-center gap-3">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <h1 class="app-title">PDI Master System</h1>
    </div>
    <div class="nav nav-pills">
        <button class="nav-link active" onclick="switchTab('form')">üìù Data Entry</button>
        <button class="nav-link" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="nav-link" onclick="switchTab('closure')">üîê Closure</button>
    </div>
</div>

<div class="container-fluid mt-4">

    <!-- DATA ENTRY TAB -->
    <div id="tab-form">
        <form id="pdiForm">
            <input type="hidden" id="editRowIndex"> 
            <div class="card">
                <div class="card-header">General Information</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3"><label class="fw-bold">Date</label><input type="date" id="date" class="form-control" required></div>
                        <div class="col-md-3">
                            <label class="fw-bold">Line</label>
                            <select id="line" class="form-select" onchange="detectFloor()" required><option value="">Select Line</option></select>
                        </div>
                        <div class="col-md-3"><label class="fw-bold">Model</label><select id="model" class="form-select"></select></div>
                        <div class="col-md-3"><label class="fw-bold">Color</label><select id="color" class="form-select"></select></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Lot Details</span>
                    <button type="button" class="btn btn-sm btn-light" onclick="addLotRow()">+ Add Lot</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light">
                            <tr><th>Lot ID</th><th>Qty</th><th>Status</th><th>Result</th><th>Defects</th><th>Action</th></tr>
                        </thead>
                        <tbody id="lotContainer"></tbody>
                    </table>
                </div>
            </div>

            <div class="text-end mb-4">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
                <button type="submit" id="saveBtn" class="btn btn-success px-5">Save Data</button>
            </div>
        </form>

        <!-- RECENT RECORDS TABLE -->
        <div class="card">
            <div class="card-header bg-dark text-white">Recent Records (Latest 50 Entries)</div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-hover table-striped text-center align-middle">
                        <thead class="table-secondary sticky-top">
                            <tr>
                                <th>Date</th><th>Line</th><th>Model</th><th>Lot ID</th><th>Result</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="crudTable">
                            <tr><td colspan="6" class="text-muted">Loading records...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD & CLOSURE TABS (Keep existing structures) -->
    <div id="tab-dashboard" style="display:none;">
        <h3 class="text-center mt-5">Dashboard Analytics Loaded...</h3>
        <!-- Existing charts code can stay here -->
    </div>
    <div id="tab-closure" style="display:none;">
         <h3 class="text-center mt-5">Lot Closure Traceability...</h3>
    </div>

</div>

<script>
// REPLACE WITH YOUR URL
const API_URL = "https://script.google.com/macros/s/AKfycbyKy7X0OWvjeMSVpM36HGH3fVE_XQQ8alDUbhh1msX9gjVPHBtGvdvgkuOefSGfSRX7/exec"; 

const MODELS = ["Ad Unity ANC", "Ace", "Ad 111v2", "Ad 118", "Ad 120", "Ad 121Pro Plus", "Ad 131 Elite Anc", "Ad 131 Gen 2", "Ad 131 Pro Buds", "Ad 138 Gen 2", "Ad 141 Anc", "Ad 141 Anc Elite", "Ad 141 Gen 2", "Ad 141 Pro Buds", "Ad 148 Gen 2", "Ad 155", "Ad 161 Anc", "Ad 161 Anc Elite", "Ad 161 N", "Ad 181 Pro", "Ad 191 Anc", "Ad 192", "Ad 212", "Ad 213", "Ad 280 Anc", "Ad 300", "Ad 301", "Ad 311 Pro", "Ad 313", "AD 71", "Ad 800", "Ad 800 Hidef", "Ad 91", "Ad 91 Prime", "Ad Ace Gen 2", "Ad Alpha Gen 2", "AD Hype", "AD Kick", "Ad Nirvana Crystal", "Ad Nirvana Iris", "Ad Nirvana X", "Ad Plus 311", "Ad Plus 318", "Ad Prime 412", "Ad Prime 513 Anc", "Ad Primo", "Ad Pulse", "Ad Supreme", "Ad Ultra Pro", "Ad100", "Ad121 Pro", "Ad125", "Ad131", "Ad131 Pro", "Ad138", "Ad138 Pro", "Ad141", "Ad148", "Ad161", "AD161 Pro-Buds", "AD163", "AD170", "AD181", "AD183", "AD190", "AD191 G", "Airdopes 207", "Alpha", "Amazon basics", "Atom 81 Pro", "Atom 83", "Atom81", "HMD P50", "HMD P60", "HMD P70", "HMD S60", "HMD X50", "HMD X50 Pro", "IMT 100", "IMT101", "IMT121", "IMT128", "IMT131", "IMT161", "IMT181", "Joy", "Max", "Nirvana", "Nirvana Ion (ANC)", "Nirvana ION ANC Pro", "Nirvana ION N Mold", "R 195 Pro", "Ultra Plus", "Zing"];

const COLOURS = ["Black", "Blue", "Bold Blue", "Crimson Cream", "Graphite Grey", "Ivory White", "Krypton Blue", "Lavender Rush", "Moon White", "Pine Green", "Space Grey", "Sterling Silver", "White", "Zinc White", "Active Black", "Active Teal", "Active White", "Aero Blue", "Aqua Blue", "Arctic Whisper", "Ash Grey", "Assassin Black", "Assassin Red", "Azure Blue", "Berry Blue", "Black Sabre", "Blazing Comet", "Blazing Red", "Captain's Blue", "Carbon Black", "CarbonBlack", "Charcoal Black", "Cherry Blossom", "Chrome White", "Coco Brown", "Cool Grey", "Cool sapphire", "Coral Bloom", "Cosmic Onyx", "Cream White", "Crimsom Red", "Crystal Black", "Cyan cider", "Dark Cyan", "Dawn Blue", "Deep Blue", "Dusk Blue", "Electric Blue", "Emerald Green", "Fiery Black", "Frost White", "Frosted Mint", "Galactic Purple", "Galactic Red", "Gold Mist", "Green", "Green Cyan", "Green Fury", "Green giant", "Grey", "Gunmetal Black", "Hot Rouge", "Ice Blue", "Iron's Blood", "Ivory", "Ivory Elegance", "Ivory Glow", "Jade Green", "Jet Black", "Kinght Black", "King's Black", "Lilac Serenity", "Lunar White", "Maroon Lush", "Martian Green", "Metallic Grey", "Midnight Black", "Midnight Blue", "Midnight Shadow", "Mint Blue", "Mint Bubblegum", "Mint Cascade", "Mist Blue", "Mist Grey", "Mocha Elegance", "Mystic Blue", "Noir Black", "Northern Lights", "Obsidian Black", "Obsidian Noir", "Ocean Blue", "Olive Green", "Olive Slate", "Opal Black", "Orange", "Peach Blush", "Peach Dusk", "Pearl White", "Pellucid Blue", "Pellucid Green", "Pellucid Orange", "Pellucid Red", "Pellucid White", "Purple", "Quantum Black", "Quartz White", "Red", "Rose Quartz", "Saga Green", "Sahara Chic", "Sandstone", "Serene Green", "Shadow Black", "Silver", "Slate Blue", "Slate Fusion", "Slate Grey", "Sleek Black", "Smoky Amethyst", "Sonic Silver", "Spider-Man", "Spirit White", "Sporty Blue", "Starry Blue", "Sunset Blush", "Surfer Silver", "Swedish White", "Teal", "Thunder Blue", "Velvet Rouge", "White Lustre", "Yellow Pop"];

let sheetData = [];

window.onload = function() {
    // Populate Dropdowns
    let mSel = document.getElementById('model');
    MODELS.forEach(m => mSel.add(new Option(m, m)));
    let cSel = document.getElementById('color');
    COLOURS.forEach(c => cSel.add(new Option(c, c)));
    let lSel = document.getElementById('line');
    for(let i=1; i<=21; i++) lSel.add(new Option("Line "+i, i));

    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    addLotRow();
    loadAllData();
};

function addLotRow(data = null){
    const tr = document.createElement('tr');
    tr.className = 'lot-row';
    tr.innerHTML = `
        <td><input type="text" class="form-control l-id" placeholder="LOT ID" required></td>
        <td><input type="number" class="form-control l-qty" required></td>
        <td><select class="form-select l-status"><option>Fresh</option><option>Rework</option></select></td>
        <td><select class="form-select l-res" onchange="toggleDef(this)"><option value="Pass">Pass</option><option value="Fail">Fail</option></select></td>
        <td><input type="text" class="form-control d-details" placeholder="Defect details if fail" disabled></td>
        <td><button type="button" class="btn btn-danger" onclick="this.closest('tr').remove()">X</button></td>
    `;
    document.getElementById('lotContainer').appendChild(tr);
    if(data){
        tr.querySelector('.l-id').value = data[5];
        tr.querySelector('.l-qty').value = data[6];
        tr.querySelector('.l-status').value = data[7];
        tr.querySelector('.l-res').value = data[8];
        if(data[8]==='Fail'){
            tr.querySelector('.d-details').disabled = false;
            tr.querySelector('.d-details').value = data[9];
        }
    }
}

function toggleDef(sel){
    sel.closest('tr').querySelector('.d-details').disabled = (sel.value === 'Pass');
}

async function loadAllData(){
    document.getElementById('loader').style.display = 'flex';
    try {
        let res = await fetch(API_URL);
        let json = await res.json();
        sheetData = json.data;
        if(sheetData[0][0] === "Date") sheetData.shift(); // Header remove
        renderTable();
    } catch(e) { console.error("Error loading:", e); }
    document.getElementById('loader').style.display = 'none';
}

function renderTable(){
    const tbody = document.getElementById('crudTable');
    tbody.innerHTML = "";
    
    // Reverse taaki latest pehle dikhe
    let displayData = [...sheetData].reverse().slice(0, 50);
    
    displayData.forEach((row) => {
        let realIndex = sheetData.indexOf(row);
        let rowHtml = `<tr>
            <td>${row[0].split('T')[0]}</td>
            <td>Line ${row[1]}</td>
            <td>${row[3]}</td>
            <td><strong>${row[5]}</strong></td>
            <td><span class="badge ${row[8]==='Pass'?'bg-success':'bg-danger'}">${row[8]}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editRow(${realIndex})">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteRow(${realIndex})">Del</button>
            </td>
        </tr>`;
        tbody.innerHTML += rowHtml;
    });
}

function editRow(idx){
    let row = sheetData[idx];
    document.getElementById('editRowIndex').value = idx;
    document.getElementById('date').value = row[0].split('T')[0];
    document.getElementById('line').value = row[1];
    document.getElementById('model').value = row[3];
    document.getElementById('color').value = row[4];
    
    document.getElementById('lotContainer').innerHTML = "";
    addLotRow(row);
    
    document.getElementById('saveBtn').innerText = "Update Record";
    document.getElementById('saveBtn').className = "btn btn-warning px-5";
    window.scrollTo(0,0);
}

async function deleteRow(idx){
    if(!confirm("Are you sure you want to delete this record?")) return;
    document.getElementById('loader').style.display = 'flex';
    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', rowIndex: idx }) });
    loadAllData();
}

document.getElementById('pdiForm').onsubmit = async (e) => {
    e.preventDefault();
    document.getElementById('loader').style.display = 'flex';
    
    let editIdx = document.getElementById('editRowIndex').value;
    let entries = [];
    document.querySelectorAll('.lot-row').forEach(tr => {
        entries.push([
            document.getElementById('date').value,
            document.getElementById('line').value,
            "Floor Auto", // Placeholder logic
            document.getElementById('model').value,
            document.getElementById('color').value,
            tr.querySelector('.l-id').value,
            tr.querySelector('.l-qty').value,
            tr.querySelector('.l-status').value,
            tr.querySelector('.l-res').value,
            tr.querySelector('.d-details').value
        ]);
    });

    let payload = editIdx ? { action: 'edit', rowIndex: editIdx, data: entries[0] } : { action: 'save', data: entries };
    
    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
    resetForm();
    loadAllData();
};

function resetForm(){
    document.getElementById('pdiForm').reset();
    document.getElementById('editRowIndex').value = "";
    document.getElementById('lotContainer').innerHTML = "";
    document.getElementById('saveBtn').innerText = "Save Data";
    document.getElementById('saveBtn').className = "btn btn-success px-5";
    addLotRow();
}

function switchTab(tab){
    ['form','dashboard','closure'].forEach(t => document.getElementById('tab-'+t).style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    event.target.classList.add('active');
}
</script>
</body>
</html>
